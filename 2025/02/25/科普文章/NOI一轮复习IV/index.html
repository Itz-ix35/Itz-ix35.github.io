<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha256-xejo6yLi6vGtAjcMIsY8BHdKsLg7QynVlFMzdQgUuy8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"itz-ix35.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.12.3","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"show_result":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="早期作品">
<meta property="og:type" content="article">
<meta property="og:title" content="科普文章 - NOI 一轮复习 IV：组合计数">
<meta property="og:url" content="https://itz-ix35.github.io/2025/02/25/%E7%A7%91%E6%99%AE%E6%96%87%E7%AB%A0/NOI%E4%B8%80%E8%BD%AE%E5%A4%8D%E4%B9%A0IV/index.html">
<meta property="og:site_name" content="ix35&#39;s Blog">
<meta property="og:description" content="早期作品">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.luogu.com.cn/upload/image_hosting/i7xnbc6g.png">
<meta property="og:image" content="https://cdn.luogu.com.cn/upload/image_hosting/jqs3oyj8.png">
<meta property="article:published_time" content="2025-02-25T02:02:48.632Z">
<meta property="article:modified_time" content="2025-02-25T02:06:54.142Z">
<meta property="article:author" content="ix35">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.luogu.com.cn/upload/image_hosting/i7xnbc6g.png">


<link rel="canonical" href="https://itz-ix35.github.io/2025/02/25/%E7%A7%91%E6%99%AE%E6%96%87%E7%AB%A0/NOI%E4%B8%80%E8%BD%AE%E5%A4%8D%E4%B9%A0IV/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://itz-ix35.github.io/2025/02/25/%E7%A7%91%E6%99%AE%E6%96%87%E7%AB%A0/NOI%E4%B8%80%E8%BD%AE%E5%A4%8D%E4%B9%A0IV/","path":"2025/02/25/科普文章/NOI一轮复习IV/","title":"科普文章 - NOI 一轮复习 IV：组合计数"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>科普文章 - NOI 一轮复习 IV：组合计数 | ix35's Blog</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">ix35's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-essays"><a href="/essay/" rel="section"><i class="fa fa-tags fa-fw"></i>随笔选辑</a></li><li class="menu-item menu-item-game-guide"><a href="/game-guide/" rel="section"><i class="fa fa-tags fa-fw"></i>游戏攻略</a></li><li class="menu-item menu-item-game-review"><a href="/game-review/" rel="section"><i class="fa fa-tags fa-fw"></i>游戏评测</a></li><li class="menu-item menu-item-music"><a href="/music/" rel="section"><i class="fa fa-tags fa-fw"></i>音乐分享</a></li><li class="menu-item menu-item-notes"><a href="/note/" rel="section"><i class="fa fa-tags fa-fw"></i>课程笔记</a></li><li class="menu-item menu-item-solutions"><a href="/solution/" rel="section"><i class="fa fa-tags fa-fw"></i>专题题解</a></li><li class="menu-item menu-item-technology"><a href="/technology/" rel="section"><i class="fa fa-tags fa-fw"></i>科普文章</a></li><li class="menu-item menu-item-travelogue"><a href="/travel/" rel="section"><i class="fa fa-tags fa-fw"></i>远古游记</a></li><li class="menu-item menu-item-gallery"><a href="/gallery/" rel="section"><i class="fa fa-image fa-fw"></i>画廊</a></li><li class="menu-item menu-item-data"><a href="/data/" rel="section"><i class="fa fa-database fa-fw"></i>数据</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#NOI-%E4%B8%80%E8%BD%AE%E5%A4%8D%E4%B9%A0-IV%EF%BC%9A%E7%BB%84%E5%90%88%E8%AE%A1%E6%95%B0"><span class="nav-text">NOI 一轮复习 IV：组合计数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E6%B8%85%E5%8D%95-%E7%9B%AE%E5%BD%95%EF%BC%9A"><span class="nav-text">知识清单&#x2F;目录：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%EF%BC%9A"><span class="nav-text">注意事项：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%8A%A0%E4%B9%98%E5%8E%9F%E7%90%86"><span class="nav-text">1. 加乘原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%BA%8C%E9%A1%B9%E5%BC%8F%E7%B3%BB%E6%95%B0%E4%B8%8E%E5%AE%B9%E6%96%A5%E5%8E%9F%E7%90%86"><span class="nav-text">2. 二项式系数与容斥原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B9%BF%E4%B9%89%E4%BA%8C%E9%A1%B9%E5%BC%8F%E7%B3%BB%E6%95%B0"><span class="nav-text">广义二项式系数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E9%A1%B9%E5%BC%8F%E7%B3%BB%E6%95%B0"><span class="nav-text">多项式系数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%84%E5%90%88%E6%95%B0%E7%9A%84%E5%BA%94%E7%94%A8"><span class="nav-text">组合数的应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%84%E5%90%88%E6%95%B0%E7%9A%84%E6%B1%82%E6%B3%95"><span class="nav-text">组合数的求法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E9%A2%98%E7%9B%AE"><span class="nav-text">相关题目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E6%96%A5%E5%8E%9F%E7%90%86"><span class="nav-text">容斥原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E9%A1%B9%E5%BC%8F%E5%8F%8D%E6%BC%94"><span class="nav-text">二项式反演</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%AB%E6%AF%94%E4%B9%8C%E6%96%AF%E5%8F%8D%E6%BC%94"><span class="nav-text">莫比乌斯反演</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Min-Max-%E5%AE%B9%E6%96%A5"><span class="nav-text">Min-Max 容斥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E7%94%9F%E6%88%90%E5%87%BD%E6%95%B0"><span class="nav-text">4. 生成函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E5%BD%A2%E5%BC%8F%E5%B9%82%E7%BA%A7%E6%95%B0%E8%B0%88%E8%B5%B7"><span class="nav-text">从形式幂级数谈起</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%B0%E5%8B%92%E5%B1%95%E5%BC%80%E5%92%8C%E7%89%9B%E9%A1%BF%E8%BF%AD%E4%BB%A3"><span class="nav-text">泰勒展开和牛顿迭代</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E8%BF%90%E7%AE%97"><span class="nav-text">常见运算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E5%87%BD%E6%95%B0"><span class="nav-text">生成函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%84%E5%90%88%E6%84%8F%E4%B9%89"><span class="nav-text">组合意义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84%E5%9B%BE%E8%AE%A1%E6%95%B0"><span class="nav-text">简单的图计数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Burnside-%E5%BC%95%E7%90%86"><span class="nav-text">5. Burnside 引理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BE%A4%E5%92%8C%E5%AD%90%E7%BE%A4"><span class="nav-text">群和子群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%A8%E9%81%93-%E7%A8%B3%E5%AE%9A%E5%AD%90%E5%AE%9A%E7%90%86%E5%92%8C-Burnside-%E5%BC%95%E7%90%86"><span class="nav-text">轨道-稳定子定理和 Burnside 引理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%AE%E6%8D%A2%E7%BE%A4%E5%92%8C-Polya-%E5%AE%9A%E7%90%86"><span class="nav-text">置换群和 Pólya 定理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%87%A0%E4%B8%AA%E7%89%B9%E6%AE%8A%E6%95%B0%E5%88%97"><span class="nav-text">6. 几个特殊数列</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%A1%E7%89%B9%E5%85%B0%E6%95%B0"><span class="nav-text">卡特兰数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0"><span class="nav-text">斐波那契数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%AF%E7%89%B9%E6%9E%97%E6%95%B0"><span class="nav-text">斯特林数</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ix35"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">ix35</p>
  <div class="site-description" itemprop="description"></div>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Itz-ix35" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Itz-ix35" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2757336405@qq.com" title="E-Mail → mailto:2757336405@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.luogu.com.cn/user/113546" title="Luogu → https:&#x2F;&#x2F;www.luogu.com.cn&#x2F;user&#x2F;113546" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>Luogu</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/187505795" title="Bilibili → https:&#x2F;&#x2F;space.bilibili.com&#x2F;187505795" rel="noopener" target="_blank"><i class="fab fa-youtube fa-fw"></i>Bilibili</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://itz-ix35.github.io/2025/02/25/%E7%A7%91%E6%99%AE%E6%96%87%E7%AB%A0/NOI%E4%B8%80%E8%BD%AE%E5%A4%8D%E4%B9%A0IV/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ix35">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ix35's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="科普文章 - NOI 一轮复习 IV：组合计数 | ix35's Blog">
      <meta itemprop="description" content="早期作品">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          科普文章 - NOI 一轮复习 IV：组合计数
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-02-25 10:02:48" itemprop="dateCreated datePublished" datetime="2025-02-25T10:02:48+08:00">2025-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A7%91%E6%99%AE%E6%96%87%E7%AB%A0/" itemprop="url" rel="index"><span itemprop="name">科普文章</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">早期作品</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="NOI-一轮复习-IV：组合计数"><a href="#NOI-一轮复习-IV：组合计数" class="headerlink" title="NOI 一轮复习 IV：组合计数"></a>NOI 一轮复习 IV：组合计数</h1><h2 id="知识清单-目录："><a href="#知识清单-目录：" class="headerlink" title="知识清单/目录："></a>知识清单/目录：</h2><ul>
<li>加乘原理</li>
<li>二项式系数与容斥原理</li>
<li>概率期望相关</li>
<li>生成函数</li>
<li>Burnside 引理</li>
<li>几个特殊数列</li>
</ul>
<h2 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h2><ol>
<li>本文旨在复习组合计数中的一些一般思考方向，<strong>与代数关系较小，几乎所有内容都是初等的，没有什么数学门槛</strong>；</li>
<li>本文所有计数题答案（无论整数还是其他有理数）默认对 $p=998244353$ 取模。</li>
</ol>
<hr>
<h2 id="1-加乘原理"><a href="#1-加乘原理" class="headerlink" title="1. 加乘原理"></a>1. 加乘原理</h2><p>组合计数的一般形式是：对于给定的集合 $S$，对于其中满足某一性质 $P$ 的元素 $x$ 求和 $f(x)$，即求出：</p>
<script type="math/tex; mode=display">
\sum\limits_{x\in S}f(x)[P(x)]</script><p>将 $S$ 称为<strong>组合类</strong>，$x$ 称为<strong>组合对象</strong>，$f$ 称为<strong>权值函数</strong>。</p>
<p>组合类中的对象一般还会定义其大小与各种组合运算，这一点在生成函数部分探讨。</p>
<p>我们有时也直接写成：</p>
<script type="math/tex; mode=display">
\sum\limits_{x\in S}f(x)</script><p>一种基本的计数思想是<strong>构造双射</strong>：</p>
<ul>
<li>其中一种情况是不同的两个组合类中的组合对象可以一一对应，这样对两个组合类进行计数是等价的。</li>
<li>另一种情况是同一组合类中的组合对象可以建立一一对应（或多个为一组），我们只需抽取每对（或每组）中的一个进行计数，再乘上 $2$（或组大小）即可。</li>
</ul>
<p>加法原理和乘法原理是计数问题中的最基本工具。</p>
<p><strong>加法原理：</strong></p>
<p>对 $S$ 中的所有元素求和 $f(x)$，等价于将 $S$ 划分为若干个子集 $S_1,\ldots,S_m$ 的不交并，然后对它们分别求和 $f(x)$ 再相加。</p>
<script type="math/tex; mode=display">
\sum\limits_{x\in S} f(x)=\sum\limits_{i=1}^m\Big(\sum\limits_{x\in S_i}f(x)\Big)\qquad(\biguplus\limits_{i=1}^m S_i=S)</script><p><strong>乘法原理：</strong></p>
<p>将 $S$ 拆分成 $S_1,\ldots,S_m$ 的笛卡尔积，$S$ 中元素的权值 $f(x)$ 等于其拆分出的各 $S_i$ 元素权值 $f_i(x_i)$ 之积，则对 $S$ 中的所有元素求和 $f(x)$，等价于对每个 $S_i$ 进行 $f_i(x_i)$ 求和后相乘。</p>
<script type="math/tex; mode=display">
\sum\limits_{x\in S} f(x)=\prod\limits_{i=1}^m\Big(\sum\limits_{x_i\in S_i} f_i(x_i)\Big)\qquad(S_1\times \ldots\times S_m=S)</script><hr>
<p>乘法原理告诉我们可以交换 $\sum$ 和 $\prod$，而我们也可以交换多个 $\sum$：</p>
<script type="math/tex; mode=display">
\sum\limits_{x\in A}\sum\limits_{y\in B}f(x,y)=\sum\limits_{y\in B}\sum\limits_{x\in A}f(y,x)</script><p>这一点常被用于当 $B$ 的权值受 $x$ 制约时的组合计数。</p>
<hr>
<blockquote>
<p>例题 $1$：Rabbit Numbering</p>
<p>求 $n$ 元正整数组 $(x_1,\ldots,x_n)$ 的数量，使得：</p>
<ul>
<li>$x_i\leq a_i$；</li>
<li>$x_i$ 两两不等。</li>
</ul>
</blockquote>
<p>令 $S_i=[a_i]=\{1,2,\ldots,a_i\}$，$f(x_1,\ldots,x_n)=[x_1\ne x_2]\ldots[x_1\ne x_n]\ldots[x_{n-1}\ne x_n]$。</p>
<p>则我们要求的就是：</p>
<script type="math/tex; mode=display">
\sum\limits_{x_1\in S_1}\ldots\sum\limits_{x_n\in S_n}f(x_1,\ldots,x_n)</script><p>我们尝试分离每一个 $x_i$ 的权值，令：$f(x_1,\ldots,x_{i-1}|x_i)=[x_i\ne x_1]\ldots[x_i\ne x_{i-1}]$，那么要求：</p>
<script type="math/tex; mode=display">
\sum\limits_{x_1\in S_1}f(x_1)\sum\limits_{x_2\in S_2}f(x_1|x_2)\ldots\sum\limits_{x_n\in S_n}f(x_1,\ldots,x_{n-1}|x_n)</script><p>这里就是我们前面提到的”$S_i$ 的权值受 $x_1,\ldots,x_{i-1}$ 制约“的情形，我们尝试将其转化为没有制约的情形，具体地，交换求和号，使得 $a_i\leq a_{i+1}$，那么由于 $x_1,\ldots,x_{i-1}$ 两两不等且不超过 $a_i$，所以 $x_i$ 取与它们都不相等的数，就恰好有 $a_i-(i-1)$ 种方案，这是与 $x_1,\ldots,x_{i-1}$ 无关的，因此根据乘法原理，所求可以写为：</p>
<script type="math/tex; mode=display">
\prod\limits_{i=1}^n\Big(\sum\limits_{x_i\in S_i}f_i(x_i)\Big)=\prod\limits_{i=1}^n (a_i-i+1)</script><p>时间复杂度为 $O(n\log n)$。</p>
<hr>
<blockquote>
<p>例题 $2$：[AGC 023 E] Inversions</p>
<p>求 $1,\ldots,n$ 的所有满足 $p_i\leq a_i$ 的排列 $p_{1\ldots n}$ 的逆序对数总和。</p>
</blockquote>
<p>首先考虑枚举一对 $(i,j)$，设 $i<j$，求 $p_i>p_j$ 的方案数。</p>
<ol>
<li>$a_i<a_j$，那么若要 $p_i>p_j$，则 $a_i\ge p_i&gt;p_j$，不妨将 $a_j$ 变为 $a_i$，这样一来 $i,j$ 地位等价，因此 $p_i<p_j$ 和 $p_i>p_j$ 的情况数相等。</li>
<li>$a_i\ge a_j$，那么不妨算 $p_i&lt;p_j$ 的方案数，再用全体符合条件的排列数去减。</li>
</ol>
<p>展开式子，可以使用线段树维护，由于时间久远，所以我这里懒得展开了，可以去看原题题解。</p>
<p>时间复杂度为 $O(n\log n)$。</p>
<hr>
<blockquote>
<p>例题 $3$：[THUPC 2021 初赛] 区间矩阵乘法</p>
<p>给定长度为 $n$ 的序列 $a_{1\ldots n}$，有 $m$ 个查询，每次给定 $p_1,p_2,d$，求：</p>
<ul>
<li>$\sum\limits_{i=0}^{d-1}\sum\limits_{j=0}^{d-1}\sum\limits_{k=0}^{d-1}a_{p_1+d\times i+j}a_{p_2+d\times j+k}$。</li>
</ul>
<p>保证所有下标在 $[1,n]$ 中。</p>
</blockquote>
<p>要求的是把 $[p_1,p_1+d^2)$ 和 $[p_2,p_2+d^2)$ 两个下标区间中的数分别排列成 $d\times d$ 矩阵，求两个矩阵乘积的所有位置元素和。</p>
<p>首先解决弱化问题：给定矩阵 $A_{m\times n}$ 和 $B_{n\times r}$，求 $C=A\times B$ 的元素和，可以交换 $\sum$ 得到：</p>
<script type="math/tex; mode=display">
\sum\limits_{i=0}^{m-1}\sum\limits_{j=0}^{n-1}\sum\limits_{k=0}^{r-1}A_{i,j}B_{j,k}=\sum\limits_{j=0}^{n-1}\Big(\sum\limits_{i=0}^{m-1}A_{i,j}\Big)\Big(\sum\limits_{k=0}^{r-1} B_{j,k}\Big)</script><p>也就是说我们只需要计算 $A$ 每一列的和以及 $B$ 每一行的和即可。</p>
<p>放到原问题上，我们就需要计算 $a$ 序列中一些区间和以及一些下标是公差为 $d$ 等差数列的项的和，由于 $d\leq\sqrt n$，都可以直接维护。</p>
<p>时间复杂度为 $O((m+n)\sqrt n)$。</p>
<hr>
<blockquote>
<p>例题 $4$：</p>
<ul>
<li>求给定的长度为 $n$ 的序列所有区间异或和的和；</li>
<li>求给定的大小为 $n$ 的集合所有子集异或和的和。</li>
</ul>
</blockquote>
<p>位运算对不同的位有良好的线性性，因此这类问题通常可以分到每一位单独考虑，只需要解决只有 $0,1$ 的问题，代价是额外的一个 $\log v$ 的复杂度。</p>
<ul>
<li>区间异或和之和：枚举右端点 $r$，再枚举当前算的位，只需求出 $0,\ldots,r-1$ 的前缀异或和中有几个当前位与 $r$ 不同，容易使用一个变量记录。</li>
<li>子集异或和之和：枚举当前算的位，如果存在至少一个 $1$，那么随便取一个 $1$ 出来，将一个子集中的这个 $1$ 的选取状态取反，就会得到异或和等于 $0$ 和 $1$ 的子集的双射，所以为 $1$ 的子集数量是 $2^{n-1}$；否则若没有 $1$，显然所有子集异或和都是 $0$。</li>
</ul>
<p>时间复杂度为 $O(n\log v)$。</p>
<hr>
<blockquote>
<p>例题 $5$：</p>
<p>给定一棵包含 $n$ 个结点的外向树，求其拓扑排序的个数。</p>
</blockquote>
<p>把树当作有根树，一个排列是拓扑序的充要条件是：每个点都是其子树中最早出现的点。</p>
<p>设 $u$ 的子树大小为 $size_u$，那么在所有 $n!$ 个排列中，$u$ 恰好是子树中最早出现的点的概率就应该是 $\dfrac{1}{size_u}$。</p>
<p>同时由于树的优良性质，各个点的限制之间是互相独立的（因为两个点的子树要么是包含关系，要么不交），所以总的方案数其实就是：</p>
<script type="math/tex; mode=display">
n!\times \prod\limits_{i=1}^n \dfrac{1}{size_i}</script><p>时间复杂度为 $O(n)$。</p>
<hr>
<blockquote>
<p>例题 $6$：北大集训 2020 试机题（出自北大集训 2019）</p>
<p>给定 $n$ 个正整数 $d_{1\ldots n}$，求有多少个数列 $a_{1\ldots n}$ 满足：</p>
<ul>
<li>$a_i|d_i$；</li>
<li>$\prod\limits_{i=1}^n a_i\leq \prod\limits_{i=1}^n\dfrac{d_i}{a_i}$</li>
</ul>
</blockquote>
<p>我们发现令所有 $a_i$ 都变为 $\dfrac{d_i}{a_i}$ 之后原本的 $\leq$ 就变成了 $\ge$，所以我们建立的条件 $2$ 中 $\leq$ 和 $\ge$ 对应的 $a_{1\ldots n}$ 的一一对应。</p>
<p>因此，我们只需要计数 $\prod\limits_{i=1}^n a_i=\prod\limits_{i=1}^n\dfrac{d_i}{a_i}$ 的方案数 $C$ 和总方案数 $S$，则 $\dfrac{S+C}{2}$ 就是答案。</p>
<p>$S$ 是容易计算的，它就是所有 $d_i$ 因子数之积。</p>
<p>而计算 $C$ 时，由于我们已经将不等号变成了等号，所以对每个素因子是独立的，对素因子指数进行背包即可。</p>
<p>时间复杂度为 $O(n^2\log v)$。</p>
<hr>
<h2 id="2-二项式系数与容斥原理"><a href="#2-二项式系数与容斥原理" class="headerlink" title="2. 二项式系数与容斥原理"></a>2. 二项式系数与容斥原理</h2><p><strong>这一段及之后出现大量的 <code>\displaystyle</code> 和普通模式的混用，请勿在意。</strong></p>
<p>定义<strong>组合数</strong> $\binom n m$ 或 $C_n^m$ 指的是从 $n$ 个不同物体中挑选 $m$ 个不同物体形成集合的方案，其中 $n\ge m$ 且 $n,m$ 为自然数。</p>
<p>为了得到组合数的计算公式，我们借助<strong>排列数</strong>这一工具，排列数 $A_n^m$ 表示从 $n$ 个不同物体中挑选 $m$ 个不同物体排成一列的方案。</p>
<p>第 $i$ 步还剩下 $n-i+1$ 个物品，根据乘法原理就可以得到：$A_n^m=n(n-1)(n-2)\ldots(n-m+1)=\dfrac{n!}{(n-m)!}$。</p>
<p>而 $m$ 个物品的一种组合对应了 $m!$ 种排列，因此 $m!\binom n m=A_n^m$，也就是 $\displaystyle\binom n m=\dfrac{n!}{m!(n-m)!}$。</p>
<p>考虑 $(1+x)^n$ 的展开，我们可以看成有 $n$ 个物体，每个物体选就对应最终结果项乘个 $x$，这样选择 $m$ 个不同物体的方案就对应最终结果 的 $m$ 次项系数，因此 $\binom n m$ 就是 $<a href="1+x">x^m</a>^n$，这个结论被称为<strong>二项式定理</strong>，因此组合数也称为<strong>二项式系数</strong>。</p>
<p>当 $n$ 是自然数但 $n&lt;m$ 时，认为 $\binom n m=0$。</p>
<p>二项式系数排列成的一个三角形称为杨辉三角或帕斯卡三角。</p>
<p>二项式系数有很多简单性质：</p>
<ul>
<li>$\displaystyle\binom n 0=1, \binom n 1=n, \binom n 2=\dfrac{n(n-1)}{2}$；</li>
<li>$\displaystyle \binom n m=\binom n {n-m}$；</li>
<li>$\displaystyle \binom n m=\binom {n-1}{m-1}+\binom {n-1} m$，这是因为从 $n$ 个中选 $m$ 个，枚举最后一个选不选，若选就是从前 $n-1$ 个里选 $m-1$ 个，否则就是从前 $n-1$ 个里选 $m$ 个。</li>
<li>$\displaystyle\sum\limits_{i=0}^n\binom n i=2^n$，这是因为根据二项式定理它等于 $(1+1)^n=2^n$；</li>
<li>$\displaystyle \sum\limits_{i=0}^n(-1)^{i}\binom n i=0 (n\ge 1)$，这是因为根据二项式定理它等于 $(1-1)^n=0$；</li>
<li>$\displaystyle \binom n 1+\binom n 3+\binom n 5+\ldots=\binom n 0+\binom n 2+\binom n 4+\ldots=2^{n-1} (n\ge 1)$，可以由前两个命题得到。</li>
</ul>
<p>接下来再介绍一下略微不太显然的性质：</p>
<ul>
<li>$\displaystyle (n-m)\times \binom n m=n\times \binom {n-1}m$，直接根据计算公式展开得证。</li>
<li>$\displaystyle m\times \binom n m=n\times \binom {n-1}{m-1}$，直接根据计算公式展开得证。</li>
<li>$\displaystyle\sum\limits_{i=0}^n i\times \binom n i=n\times 2^{n-1}$，根据上一条可证，据此还可以得到形如 $\displaystyle\sum\limits_{i=0}^n i^k\times \binom n i $ 的计算方法。</li>
<li><strong>上指标求和：</strong>$\displaystyle \sum\limits_{i=0}^n \binom i m=\binom {n+1}{m+1}$，组合意义：枚举从 $n+1$ 个物品中选 $m+1$ 个物品中的最后一个物品。</li>
<li><strong>对角线求和：</strong>$\displaystyle\sum\limits_{i=0}^n\binom {m+i} i=\binom {m+n+1}{n}$，利用上面第三条简单性质可归纳。</li>
<li><strong>范德蒙德卷积：</strong>$\displaystyle \sum\limits_{i=0}^{k}\binom n i\binom m {k-i}=\binom {n+m} k$，组合意义：从大小为 $n,m$ 的两堆中总共选出 $k$ 个物品。 </li>
<li><strong>范德蒙德卷积另一形式：</strong>$\displaystyle \sum\limits_{i=0}^{\min(n,m-k)}\binom n i\binom m {i+k}=\binom {n+m} {n+k}$，只需将 $\displaystyle \binom n i$ 替换成 $\displaystyle \binom n {n-i}$ 即可。</li>
<li><strong>平方求和：</strong>$\displaystyle\sum\limits_{i=0}^n\binom n i^2=\binom {2n} n$，这是范德蒙德卷积第二形式的简单推论。</li>
</ul>
<p>利用二项式定理解释范德蒙德卷积的本质：$(1+x)^n\times (1+x)^m=(1+x)^{n+m}$。</p>
<hr>
<h3 id="广义二项式系数"><a href="#广义二项式系数" class="headerlink" title="广义二项式系数"></a>广义二项式系数</h3><p>将二项式系数的上指标 $n$ 由自然数扩展到任意实数，就得到了<strong>广义二项式系数</strong>：$\displaystyle\binom n m=\dfrac{n(n-1)\ldots (n-m+1)}{m!}$，</p>
<p>注意 $m$ 始终必须是一个自然数。</p>
<p>在广义二项式系数的定义下，当 $n&lt;m$ 且 $n$ 是自然数时有 $\binom n m=0$，和我们此前的约定相同。</p>
<p>与之对应的有<strong>广义二项式定理</strong>：</p>
<script type="math/tex; mode=display">
(1+x)^\alpha=\sum\limits_{m=0}^{+\infty}\binom \alpha m x^m\quad(x\in [-1,1])</script><p>证明先空着，回去翻一下书。</p>
<p>关于广义二项式系数有一个基本的恒等式：</p>
<ul>
<li><strong>上指标反转：</strong>$\displaystyle \binom n m=\binom {m-n-1}{m}\times (-1)^m$，直接展开即可证明。</li>
</ul>
<hr>
<h3 id="多项式系数"><a href="#多项式系数" class="headerlink" title="多项式系数"></a>多项式系数</h3><p>还可以从另一个角度对二项式系数进行推广：</p>
<p>将 $n$ 个不同物体划分成 $m$ 个集合，第 $i$ 个集合大小为 $a_i$，有 $\sum a_i=n$，求总方案数，这个问题是<strong>多重组合问题</strong>。</p>
<p>将方案数记为<strong>多项式系数</strong> $\displaystyle \binom n {a_1,a_2,\ldots,a_m}$，则我们可以依次确定每个集合选取哪些元素，也就是：</p>
<script type="math/tex; mode=display">
\binom n {a_1,a_2,\ldots,a_m}=\prod\limits_{i=1}^m \binom {a_i+\ldots+a_m}{a_i}=\prod\limits_{i=1}^m \dfrac{(a_i+\ldots+a_m)!}{a_i!\times (a_{i+1}+\ldots+a_m)!}=\dfrac{n!}{a_1!a_2!\ldots a_m!}</script><p>与之对应的有<strong>多项式定理</strong>：</p>
<script type="math/tex; mode=display">
(\sum\limits_{i=1}^m x_i)^n=\sum\limits_{\sum\limits_{i=1}^m a_i=n}\binom n {a_1,a_2,\ldots,a_m}\times\prod\limits_{i=1}^m x_i^{a_i}</script><p>通过组合意义证明和二项式定理类似。</p>
<hr>
<h3 id="组合数的应用"><a href="#组合数的应用" class="headerlink" title="组合数的应用"></a>组合数的应用</h3><p>下面介绍几个组合数的实际应用。</p>
<p>首先是<a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P5824">十二重计数法</a>中的一部分，将 $n$ 个球放入 $m$ 个盒子中，要求：</p>
<ul>
<li><p>球之间互不相同，盒子之间也互不相同：</p>
<ul>
<li><p>$\text{I}$：无其他限制。</p>
<p>每个球独立，可以放入 $m$ 个盒子中的任何一个，所以答案为 $n^m$。</p>
</li>
<li><p>$\text{II}$：每个盒子至多放一个球。</p>
<p>首先枚举 $m$ 个盒子中的 $n$ 个放球，然后球之间可以任意交换，所以答案为 $\binom m n\times n!$。</p>
</li>
<li><p>$\text{III}$：每个盒子至少放一个球。</p>
<p>需要使用容斥原理，得到结果为 $\sum\limits_{i=0}^m (-1)^i\times \binom m i\times (m-i)^n$。</p>
</li>
</ul>
</li>
<li><p>球之间互不相同，盒子之间都相同：</p>
<p>此部分基本需要用到第二类斯特林数。</p>
</li>
<li><p><strong>球之间都相同，盒子之间互不相同：</strong></p>
<ul>
<li><p>$\text{VII}$：无其他限制。</p>
<p>最经典的解释方法是隔板法，将 $n$ 个球排成一排，在中间插入 $m-1$ 块隔板，分成 $m$ 段，第 $i$ 段就表示第 $i$ 个盒子里装的球。</p>
<p>可以看成事先有 $n+m-1$ 个东西，其中要分成 $n$ 个球和 $m-1$ 块隔板。</p>
<p>所以答案为 $\binom {n+m-1} n$。</p>
</li>
<li><p>$\text{VIII}$：每个盒子至多放一个球。</p>
<p>在 $m$ 个盒子中选 $n$ 个放球，所以答案为 $\binom m n$。</p>
</li>
<li><p>$\text{IX}$：每个盒子至少放一个球。</p>
<p>先给每个盒子塞上一个球，然后转化成 $\text{VII}$。</p>
</li>
</ul>
</li>
<li><p>球之间都相同，盒子之间都相同：</p>
<p>此部分基本需要用到划分数和生成函数解释。</p>
</li>
</ul>
<p>这里主要要说明的是 $\text{VII}$ 和 $\text{IX}$，归纳出来可以得到：</p>
<ul>
<li>将 $n$ 划分成 $m$ 个有序自然数的和，方案数等于 $\binom {n+m-1}{n}$；</li>
<li>将 $n$ 划分成 $m$ 个有序正整数的和，方案数等于 $\binom {n-1}{m-1}$。</li>
</ul>
<p>将 $=$ 改成 $\leq$ 也类似，例如 $\text{VII}$，只需添加一个自然数将少的部分补齐，也就是将 $n$ 划分成 $m+1$ 个有序自然数的和，即可。</p>
<p>另一个和组合数相关的实际问题是路径计数问题：</p>
<p>从网格图的左上角 $(0,0)$ 走到右下角 $(n,m)$，每次只能向右或向下走一步，总方案数为 $\binom {n+m} n$，因为总共要走 $n+m$ 步，其中 $n$ 步是向右的，其余 $m$ 步是向下的。</p>
<hr>
<h3 id="组合数的求法"><a href="#组合数的求法" class="headerlink" title="组合数的求法"></a>组合数的求法</h3><ul>
<li><p>情况 $1$：给定 $n$，求所有 $\displaystyle \binom i j$（$0\leq j\leq i\leq n$），模数不一定是素数。</p>
<p>使用递推式 $\displaystyle \binom n m=\binom {n-1} {m-1}+\binom {n-1} m$ 以及 $\displaystyle\binom n 0=1$，时间复杂度为 $O(n^2)$。</p>
</li>
<li><p>情况 $2$：有 $q$ 组询问，每次给出一组 $a,b$，询问 $\displaystyle\binom a b$（$0\leq b\leq a\leq n$），模数是大于 $n$ 的素数。</p>
<p>预处理 $n!\bmod p$ 和 $\dfrac{1}{n!}\bmod p$，每次带入公式，时间复杂度为 $O(q+n)$。</p>
<p>另一种方法是每次暴力计算 $\dfrac{a(a-1)\ldots (a-b+1)}{b!}$，时间复杂度为 $O(\sum b)$，有时会更有用，并且当我们需要递推计算 $\displaystyle \binom n 0,\binom n 1,\ldots,\binom n m$ 时这种方法的复杂度仅为 $O(m)$。</p>
</li>
</ul>
<p>接下来要先说明 Lucas 定理。</p>
<p><strong>Lucas 定理：设 $n,m$ 的 $p$ 进制表示分别是 $\overline{a_k\ldots a_0},\overline{b_k\ldots b_0}$，那么 $\displaystyle\binom n m\equiv \prod\limits_{i=0}^k \binom {a_i}{b_i}\bmod p$，其中 $p$ 是素数，$n,m$ 是自然数。</strong></p>
<p>该定理用二项式定理证明，我们首先需要一个引理：</p>
<p>$(1+x)^{p^k}\equiv (1+x^{p^k})\bmod p$，指两边各项系数对应同余。</p>
<p>这是因为 $\displaystyle\binom {p^k} x\equiv 0\bmod p (x\in [1,p^k-1])$，考察式子上下 $p$ 的幂次即可，这一点稍后详讲。</p>
<p>那么我们来看二项式定理的形式：</p>
<script type="math/tex; mode=display">
(1+x)^n=\prod(1+x)^{a_ip^i}\equiv \prod (1+x^{p^i})^{a_i}</script><p>我们要求这个式子的 $m$ 次项系数，就需要最右侧连乘式中的指数之和等于 $m$，而由于 $a_i&lt;p$，所以想要用右侧的和组合出 $m$ 的方法至多一种，也就是：</p>
<script type="math/tex; mode=display">
[x^m](1+x)^n=\prod [x^{b_i}](1+x^{p^i})^{a_i}</script><p>而这正是 Lucas 定理的表述。</p>
<p>这里再写一些和 Lucas 定理关系较大的数论内容。</p>
<p>首先我们看到上面的一个表述：</p>
<blockquote>
<p>这是因为 $\displaystyle\binom {p^k} x\equiv 0\bmod p (x\in [1,p^k-1])$，考察式子上下 $p$ 的幂次即可。</p>
</blockquote>
<p>事实上，我们可以得到更进一步的表述：</p>
<p><strong>命题：$\displaystyle\binom {n+m} n\equiv 0\bmod p$ 当且仅当 $n$ 与 $m$ 的加法在 $p$ 进制下发生进位，其中 $p$ 是素数。 </strong></p>
<p>而这是另一个定理的一个特殊情况：</p>
<p><strong>Kummer 定理：$\dfrac{(n+m)!}{n!\times m!}$ 中质因子 $p$ 的次数恰好为 $n+m$ 计算过程中在 $p$ 进制下的进位次数。</strong></p>
<p>证明：根据简单的数论知识可以知道 $n!$ 中素因子 $p$ 的次数为 $\sum\limits_{i=1}^{+\infty} \lfloor\dfrac{n}{p^i}\rfloor$。</p>
<p>因此这个二项式系数中 $p$ 的幂次就是 $\sum\limits_{i=1}^{+\infty}(\lfloor\dfrac{n+m}{p^i}\rfloor-\lfloor\dfrac{n}{p^i}\rfloor-\lfloor\dfrac{m}{p^i}\rfloor)$。</p>
<p>括号中的这个东西我们称为 $g_i$，根据 $\lfloor\dfrac{a}{b}\rfloor=\dfrac{a-a\bmod b}{b}$，所以有：</p>
<script type="math/tex; mode=display">
g_i=\dfrac{n+m-(n+m)\bmod p^i}{p^i}-\dfrac{n-n\bmod p^i}{p^i}-\dfrac{m-m\bmod p^i}{p^i}=\dfrac{n\bmod p^i+m\bmod p^i-(n+m)\bmod p^i}{p^i}</script><p>令 $n_i=n\bmod p^i, m_i=m\bmod p^i$：</p>
<ul>
<li>如果 $n_i+m_i&lt;p^i$，那么就对应了 $n+m$ 过程中在第 $i-1$ 位上没有进位到第 $i$ 位，此时根据上面的式子 $g_i=0$；</li>
<li>如果 $n_i+m_i\ge p^i$，那么就对应了第 $i-1$ 位进了一位，此时 $(n+m)\bmod p^i=n_i+m_i-p^i$，所以 $g_i=1$。</li>
</ul>
<p>综上，$\sum g_i$ 就是 $n+m$ 在 $p$ 进制计算过程中的进位次数，而这也就是 $\displaystyle \binom {n+m} n$ 中 $p$ 这个素因子的出现次数。</p>
<p>下面让我们回到求组合数的问题上。</p>
<ul>
<li><p>情况 $3$：有 $q$ 组询问，每次给出一组 $a,b$，询问 $\displaystyle\binom a b$（$0\leq b\leq a\leq n$），<strong>模数是较小的（比 $n$ 小的）素数 $p$</strong>。</p>
<p>此时套用情况 $2$ 的做法，不仅复杂度有一个较大的 $n$，同时还会产生 $p$ 的倍数没有逆元的情况。</p>
<p>因此我们选择用 Lucas 定理转化成 $a,b&lt;p$ 的情形，然后使用情况 $2$ 解决。</p>
<p>注意此过程的一般实现方法：递归计算 $\displaystyle \binom n m$，如果 $n,m&lt;p$ 则直接计算，否则根据 Lucas 定理有 $\displaystyle \binom n m\equiv \binom {n\bmod p}{m\bmod p}\binom {\lfloor\frac{n}{p}\rfloor}{\lfloor\frac{m}{p}\rfloor}$，据此进行递归即可，由于 $n\bmod p, m\bmod p&lt;p$，所以其实只会递归一边。</p>
<p>时间复杂度为 $O(p+\dfrac{q\log n}{\log p})$。</p>
</li>
<li><p>情况 $4$：有 $q$ 组询问，每次给出一组 $a,b$，询问 $\displaystyle\binom a b$（$0\leq b\leq a\leq n$），<strong>模数是较小的正整数 $m$，可能是合数</strong>。</p>
<p>这里的处理方法被称为扩展 Lucas，但是实际上和 Lucas 定理关系不大。</p>
<p>首先设 $m=\prod p_i^{c_i}$，其中 $p_i$ 是素数，也就是说我们将 $m$ 进行了素因数分解，然后我们只需要求出所有 $\displaystyle \binom a b\bmod p_i^{c_i}$ 再用中国剩余定理合并即可。</p>
<p>而这里求解 $\displaystyle \binom a b\bmod p_i^{c_i}$ 的核心困难是 $\bmod p_i^{c_i}$ 意义下阶乘逆元可能不存在，而解决方法是提取出 $\displaystyle\binom a b$ 中素因子 $p_i$ 的次数，然后对剩余部分用求逆计算。</p>
<p>设 $a!,b!,(a-b)!$ 中 $p_i$ 的幂次分别为 $u,v,w$，那么就有 $\displaystyle\binom a b= \dfrac{\frac{a!}{p_i^u}}{\frac{b!}{p_i^v}\times \frac{(a-b)!}{p_i^w}}\times p_i^{u-v-w}$，所以接下来我们分别计算形如 $\dfrac{a!}{p_i^u}$ 的式子以及这里的 $u$。</p>
<p>其中 $u$ 是非常容易计算的，在 Kummer 定理的证明过程中已经写了，它就是 $\sum\limits_{k=1}^{+\infty} \lfloor\dfrac{a}{p_i^k}\rfloor$。</p>
<p>而形如 $\dfrac{a!}{p_i^u}\bmod p_i^{c_i}$ 的式子可以采用递归的方法计算：</p>
<script type="math/tex; mode=display">
a!=p_i^{\lfloor\frac{a}{p_i}\rfloor}\times \lfloor\frac{a}{p_i}\rfloor!\times \prod\limits_{i=1,i\bmod p\ne 0}^{n} i</script><p>在 $\bmod p_i^{c_i}$ 意义下，后者是一个以 $p_i^{c_i}$ 为周期的函数的前缀积，通过一定的预处理（$O(p_i^{c_i})$）可以在 $O(1)$ 的时间内求出。</p>
<p>而前面的阶乘则要继续递归。</p>
<p>上面过程做一遍的复杂度是 $O(p_i^{c_i}+\dfrac{\log n}{\log p_i})$，所以算上 $q$ 次询问的时间复杂度不超过 $O(m+q\omega(m)\log n)$。</p>
</li>
</ul>
<p>除了直接求一个组合数的值以外，还有一些相关的问题，这里也提一下：</p>
<ul>
<li><p>组合数比大小：</p>
<p>给定两个二项式系数 $\displaystyle \binom a b$ 和 $\displaystyle \binom c d$，比较它们的大小。</p>
<p>将两边取对数，有 $\ln \displaystyle \binom a b=\sum\limits_{i=1}^a \ln i-\sum\limits_{i=1}^b\ln i-\sum\limits_{i=1}^{a-b}\ln i$，而这个数是不超过 $a\ln a$ 的，直接比较两个对数的大小即可。</p>
</li>
<li><p>组合数前缀和：</p>
<p>有 $q$ 组询问，每组询问给定 $n,m$，求出 $\displaystyle\sum\limits_{i=0}^m \binom n i$。</p>
<p>这里所说的是一种 $O((q+n)\sqrt n)$ 的做法，设题目所求为 $S(n,m)$。</p>
<p>根据定义有 $\displaystyle S(n,m+1)=S(n,m)+\binom n {m+1}$，而 $\displaystyle S(n,m-1)=S(n,m)-\binom n {m-1}$。</p>
<p>此外根据杨辉三角的递推公式，我们有 $\displaystyle S(n+1,m)=2\times S(n,m)-\binom n m$，反过来就是 $\displaystyle S(n-1,m)=\dfrac{S(n,m)+\binom{n-1}{m}}{2}$。</p>
<p>所以可以套上莫队进行求解，事实上只需要有 $S(n,m)$ 到 $S(n,m+1)$ 和 $S(n+1,m)$ 就符合使用莫队的条件了，时间复杂度为 $O((q+n)\sqrt n)$。</p>
</li>
</ul>
<hr>
<h3 id="相关题目"><a href="#相关题目" class="headerlink" title="相关题目"></a>相关题目</h3><p>为了保证前面内容的连贯性，将例题全都放到这里。</p>
<hr>
<blockquote>
<p>例题 $7$：[ABC 154 F] Many Many Paths</p>
<p>求 $\displaystyle \sum\limits_{i=a}^b\sum\limits_{j=c}^d \binom {i+j}{i}$。</p>
</blockquote>
<p>固定 $j$ 后是一个对角线求和，根据公式，答案等于：</p>
<script type="math/tex; mode=display">
\sum\limits_{j=c}^d\Big(\binom {j+b+1} b-\binom {j+a}{a-1}\Big)</script><p>然后这是两个上指标求和，我们知道答案为：</p>
<script type="math/tex; mode=display">
\binom{b+d+2}{b+1}-\binom {b+c+1}{b+1}-\binom {a+d+1}{a}+\binom {a+c}{a}</script><p>当然，上指标求和与对角线求和的本质是相同的。</p>
<p>时间复杂度为 $O(a+b+c+d)$。</p>
<hr>
<blockquote>
<p>例题 $8$：[CERC 2015] Frightful Formula</p>
<p>给定 $F(1,i)$ 和 $F(i,1) (i\in [1,n])$，并且有 $F(i,j)=aF(i-1,j)+bF(i,j-1)+c (i,j\in [2,n])$，求 $F(n,n)$。</p>
</blockquote>
<p><strong>解一：</strong></p>
<p>考虑按照网格图路径计数的方法，给递归式赋予一个合适的意义。</p>
<p>由于有形如 $aF(i-1,j)+bF(i,j-1)$ 这样的式子，我们如下定义这一部分答案：从 $(2,i)$ 或 $(i,2)$ 往 $(n,n)$ 每次向右或向下行走，向右的权值为 $b$，向下的权值为 $a$，路径权值为每一步权值的积，将所有路径权值之和乘上 $F(1,i)$ 或 $F(i,1)$ 后求和。</p>
<p>类似地，我们对 $c$ 也赋予一个意义：从每个 $(i,j) (i,j\in [2,n])$ 出发，到 $(n,n)$ 且每次只能向右或向下行走，向右权值为 $b$，向下权值为 $a$，求所有路径权值之和乘上 $c$。</p>
<p>根据路径计数的结论，答案如下：</p>
<script type="math/tex; mode=display">
\sum\limits_{i=2}^n \binom {2n-i-2}{n-2}a^{n-2}b^{n-i}F(1,i)+\sum\limits_{i=2}^n\binom {2n-i-2}{n-2}b^{n-2}a^{n-i}F(i,1)+c\sum\limits_{i=2}^n\sum\limits_{j=2}^n \binom {2n-i-j}{n-i}a^{n-i}b^{n-j}</script><p>前两项直接暴力计算即可，我们考虑最后一项，将之稍加改写：</p>
<script type="math/tex; mode=display">
c\sum\limits_{i=0}^{n-2}\sum\limits_{j=0}^{n-2}\binom {i+j}{i}a^ib^j</script><p>这似乎是上题的加强版，有趣的是，我的解法在解决本题是当 $a=b=1$ 时需要特判并使用上题的解法解决，因此这种解法并不能包含掉上题。</p>
<p>考虑设 $\displaystyle S_i=\sum\limits_{j=0}^{n-2}\binom {i+j} j\times b^j$，答案为 $\displaystyle\sum\limits_{i=0}^{n-2} S_i\times a^i$，我们只需要想办法计算 $S_i$。</p>
<p>可以建立 $S_i$ 和 $S_{i+1}$ 之间的递推关系：</p>
<script type="math/tex; mode=display">
S_{i+1}=\sum\limits_{j=0}^{n-2}\Big(\binom {i+j}{j}+[j>0]\binom {i+j}{j-1}\Big)b^{j}=S_i+bS_{i+1}-\binom {i+n-1}{n-2}b^{n-1}</script><p>可以解得：</p>
<script type="math/tex; mode=display">
S_{i+1}=\dfrac{\binom {i+n-1}{n-2}b^{n-1}-S_i}{b-1}</script><p>当 $b\ne 1$ 或 $a\ne 1$ 时我们可以采用这个递推，否则采用上题的做法。</p>
<p>这是我在做集训队作业的时候的原解法。</p>
<p><strong>解二：</strong></p>
<p>由于 $c=0$ 的情况是容易的，所以我们可以将问题转化为 $c=0$ 的情况。</p>
<p>考虑令 $G(i,j)=F(i,j)-\Delta$，使得 $G(i,j)=aG(i-1,j)+bG(i,j-1)$，那么有 $\Delta=a\Delta+b\Delta+c$，所以令 $\Delta=\dfrac{c}{1-a-b}$ 即可。</p>
<p>问题到这里已经基本解决，但这道原题的模数是较小的 $10^6+3$，有可能出现 $1-a-b\equiv 0$ 的情况，所以我们还需要对 $a+b\equiv 1$ 的情况进行讨论。</p>
<p>考虑改进 $\Delta$ 的定义，将它设为函数 $\Delta(i,j)$，我们依然有 $\Delta(i,j)=a\Delta(i-1,j)+b\Delta(i,j-1)+c$，我们可以设 $\Delta(i,j)=c(i+j)$，可以验证当 $a+b\equiv 1$ 时符合条件。</p>
<p>两种做法复杂度都为 $O(n)$，但解一相对基础，解二似乎需要一定的构造和观察。</p>
<hr>
<blockquote>
<p>例题 $9$：[AHOI 2017 / HNOI 2017] 抛硬币</p>
<p>甲抛掷 $a$ 次硬币，乙抛掷 $b$ 次硬币，问甲抛出正面朝上的次数更多的方案数，模数为 $10^9$，保证 $a\ge b$。</p>
<p>$a,b$ 可达 $10^{15}$，而 $a-b\leq 10^4$。</p>
</blockquote>
<p>将甲抛出的正面朝上更多的情况称为甲胜，一样多的情况称为平局，否则称为乙胜。</p>
<p>不妨从 $a=b$ 的情况开始讨论，这有些类似例题 $6$，我们知道甲胜和乙胜的情况一一对应，因此只需要算出总方案数 $S$ 和平局数 $C$，那么 $\dfrac{S-C}{2}$ 就是答案。</p>
<p>显然 $S=2^{2a}$，而平局的情况，我们只需枚举有几次硬币朝上，所以答案就是：</p>
<script type="math/tex; mode=display">
\dfrac{2^{2a}-\sum\limits_{i=0}^a \binom {a}{i}^2}{2}=\dfrac{2^{2a}-\binom {2a}{a}}{2}</script><p>接下来我们尝试用相同的方法讨论 $a&gt;b$ 的情况。</p>
<p>先前是甲胜和乙胜一一对应，但是现在由于甲抛的次数多，所以不管是乙胜还是平局，将每次抛硬币结果反转后都会得到一个甲胜的局面，仔细思考发现这其实也是一个双射：<strong>乙胜的情况和平局的情况加起来和一部分甲胜的情况一一对应。</strong></p>
<p>因此我们只需要计算那些<strong>本来是甲胜，全部反转后还是甲胜</strong>的方案数 $C$，则 $\dfrac{S+C}{2}$ 就是答案。</p>
<p>设这种局面中甲正面朝上 $i$ 次，乙正面朝上 $j$ 次，列出 $i&gt;j, a-i&gt;b-j$ 的不等式，得到 $1\leq i-j\leq a-b-1$。</p>
<p>由此可以直接写出答案：</p>
<script type="math/tex; mode=display">
\dfrac{2^{a+b}+\sum\limits_{u=0}^b\sum\limits_{v=1}^{a-b-1}\binom b u\binom a {u+v}}{2}</script><p>注意式子中的 $u,v$ 分别是 $j$ 和 $i-j$。</p>
<p>交换求和顺序，里面可以使用范德蒙德卷积的第二形式化简：</p>
<script type="math/tex; mode=display">
\dfrac{2^{a+b}+\sum\limits_{v=1}^{a-b-1}\sum\limits_{u=0}^{b}\binom b u\binom a {u+v}}{2}=\dfrac{2^{a+b}+\sum\limits_{v=1}^{a-b-1}\binom {b+a}{b+v}}{2}</script><p>于是我们只需要使用扩展 Lucas 计算 $O(a-b)$ 次组合数即可得到结果。</p>
<p>需要特别注意的是，$a=b$ 的情况由于平局不对应甲胜，所以和后面的式子<strong>不同</strong>！</p>
<p>时间复杂度为 $O((a-b)\log a+5^9)$。</p>
<hr>
<blockquote>
<p>例题 $10$：</p>
<p>求有多少组 $a_1,\ldots,a_k$ 满足：</p>
<ul>
<li>$a_i\leq x_i$；</li>
<li>$\displaystyle\binom {\sum a_i}{a_1,\ldots,a_k}$ 是奇数。</li>
</ul>
</blockquote>
<p>我们可以通过将多项式系数拆为二项式系数的乘积，从而推广 Kummer 定理：</p>
<script type="math/tex; mode=display">
\displaystyle\binom {\sum a_i}{a_1,\ldots,a_k}=\prod\limits_{i=1}^{k-1} \binom {a_i+\ldots+a_k}{a_i}</script><p>倒序合并可以知道，这个数不是 $p$ 的倍数，当且仅当 $a_1+\ldots+a_k$ 的任何一步中都没有进位。</p>
<p>此处 $p=2$，这个条件可以等价地刻画为：所有 $a_i$ 的二进制表示两两无交。</p>
<p>随后我们可以数位 DP，令 $f(i,S)$ 表示已经考虑二进制下最高 $i$ 位，目前 $S$ 集合中的所有 $a_i$ 的高位是和 $x_i$ 相等的，通过枚举第 $i$ 位属于哪个数（或都不属于）转移。</p>
<p>时间复杂度为 $O(2^k\times k\log x_i)$。</p>
<hr>
<h3 id="容斥原理"><a href="#容斥原理" class="headerlink" title="容斥原理"></a>容斥原理</h3><p>给定 $n$ 个集合 $S_1,\ldots,S_n$，如果我们可以轻松地算出它们中一些的交集大小，则可以据此计算它们的并集大小：</p>
<script type="math/tex; mode=display">
|\bigcup\limits_{i=1}^n S_i|=\sum\limits_{\varnothing \ne T\subseteq [n]}(-1)^{|T|-1}|\bigcap\limits_{i\in T}S_i|</script><p>其中 $[n]$ 指 $\{1,2,\ldots,n\}$，这个式子的含义是，这些集合并集的大小可以通过枚举一个子集的集合，将它们求交并乘上 $-1$ 的子集大小次方求和得到。</p>
<p>这个式子的一种理解是通过二项式定理：</p>
<script type="math/tex; mode=display">
\sum\limits_{i=1}^n (-1)^{i}\binom n i=\sum\limits_{i=0}^n\Big((-1)^{i}\binom n i\Big)-\binom n 0=-1</script><p>因此并集中的每个元素都被计算了恰好一次。</p>
<p>这个式子就是<strong>容斥原理</strong>的基本表达，此外它还有一个常见形式：</p>
<script type="math/tex; mode=display">
|\overline{\bigcup\limits_{i=1}^n S_i}|=\sum\limits_{T\subseteq [n]}(-1)^{|T|}|\bigcap\limits_{i\in T}S_i|</script><p>其中当 $T=\varnothing$ 时后面的式子定义为全集大小，容易发现这个式子只是前面那种形式取补得到的，但这种形式通常更有用。</p>
<p>我们可以直观地理解容斥原理：</p>
<ul>
<li>$n$ 件事至少发生一件的方案数，可以通过其中每个子集同时发生的方案计算；</li>
<li>$n$ 件事都不发生的方案数，可以通过其中每个子集同时发生的方案计算。</li>
</ul>
<hr>
<blockquote>
<p>例题 $11$：伯努利信封问题</p>
<p>求 $1,\ldots,n$ 的排列 $p_1,\ldots,p_n$ 的数量，使得 $i\ne p_i$。</p>
</blockquote>
<p>通常称错排问题。</p>
<p>设 $S_i$ 为所有满足 $i=p_i$ 的排列构成的集合，我们要求的就是 $|\overline{\bigcup\limits_{i=1}^n S_i}|$，采用容斥原理，求若干个 $S_i$ 交的大小，而这等价于若干个 $p_i=i$，剩下的数自由排列，这只和子集大小有关，因此我们可以写出答案：</p>
<script type="math/tex; mode=display">
|\overline{\bigcup\limits_{i=1}^n S_i}|=\sum\limits_{i=0}^n (-1)^i\binom n i(n-i)!</script><p>将里面打开，可以得到如下结果：</p>
<script type="math/tex; mode=display">
|\overline{\bigcup\limits_{i=1}^n S_i}|=n!\times \sum\limits_{i=0}^n\dfrac{(-1)^i}{i!}</script><p>设此结果为 $a_n$，我们还可以据此得到 $a_n$ 的递推式：</p>
<script type="math/tex; mode=display">
a_n=a_{n-1}\times n+(-1)^n</script><p>并且有 $a_1=0$，随后我们可以将一个 $a_{n-1}$ 改写成 $a_{n-2}\times (n-1)+(-1)^{n-1}$，所以：</p>
<script type="math/tex; mode=display">
a_n=(n-1)(a_{n-1}+a_{n-2})</script><p>这个问题还有多种做法，如考虑 $n$ 在排列中的位置，或直接使用生成函数解决。</p>
<p>时间复杂度为 $O(n)$。</p>
<hr>
<blockquote>
<p>例题 $12$：</p>
<p>求正整数列 $a_{1,\ldots ,n}$ 的数量，满足：</p>
<ul>
<li>$a_i\leq x_i$；</li>
<li>$\sum a_i=S$。</li>
</ul>
</blockquote>
<p>设 $S_i$ 是满足 $a_i&gt;x_i$ 且 $\sum a_i=S$ 的数列集合，我们要求 $|\overline{\bigcup\limits_{i=1}^n S_i}|$，采用容斥原理，求一些 $S_i$ 的交，我们不妨先将这些 $S_i$ 对应的 $x_i$ 取满，然后就没有额外的限制了，可以采用隔板法，所以：</p>
<script type="math/tex; mode=display">
|\bigcap\limits_{i\in T}S_i|=\binom {S-\sum\limits_{i\in T}x_i-1}{n-1}</script><p>套用容斥原理的式子，时间复杂度为 $O(2^n)$。</p>
<hr>
<blockquote>
<p>例题 $13$：脑力</p>
<p>给定 $n$ 个字符串 $T_1,\ldots,T_n$，字符串中有些问号表示可以填上任意小写字母，问所有填写方案中这些串构成的字典树结点数之和。</p>
</blockquote>
<p>设 $S_i$ 是字典树上第 $i$ 个串的所有前缀对应结点构成的集合，我们要求 $|\bigcup\limits_{i=1}^n S_i|$，用容斥原理转化成求每个子集的 $S_i$ 的交。</p>
<p>而 $S_i$ 的交就是它们对应的串的 LCP，可以通过枚举 LCP 长度算方案数求出。</p>
<p>时间复杂度为 $O(2^n\times |T_i|)$。</p>
<hr>
<blockquote>
<p>例题 $14$：[COCI 2009-2010 #6] XOR 加强版</p>
<p>给定 $n$ 个顶点形如 $(x_i,y_i),(x_i,y_i+l_i),(x_i+l_i,y_i)$ 的等腰直角三角形，求它们的异或面积并。</p>
<p>原题 $n\leq 10$，这里考虑 $n\leq 500$。</p>
</blockquote>
<p>这是一个变形的容斥原理，我们可以知道答案一定可以写成每个子集的交乘上一个系数求和。</p>
<p>事实上稍加推导可以发现，大小为 $m$ 的子集的容斥系数为 $(-2)^{m-1}$，提供一个归纳性证明：</p>
<script type="math/tex; mode=display">
\dfrac{(-1)^{m-1}+1}{2}-\sum\limits_{i=1}^{m-1}\binom m i\times (-2)^{i-1}=\dfrac{(-1)^{m-1}+1+(-1)^m-1-(-2)^{m}}{2}=(-2)^{m-1}</script><p>我们可以考虑枚举一个三角形 $Tri$，求交集为 $Tri$ 的子集的容斥系数和。</p>
<p>而这可以再套一层三维差分的容斥，转化为计算八个形如“包含 $Tri$ 的所有三角形集合的所有子集的容斥系数和”的东西。</p>
<p>这一点是容易的，设包含 $Tri$ 的三角形有 $m$ 个，则系数和为：</p>
<script type="math/tex; mode=display">
\sum\limits_{i=1}^m\binom m i\times (-2)^{i-1}=\dfrac{(-1)^{m}-1}{-2}</script><p>也即当 $m$ 为偶数时系数为 $0$，否则系数为 $1$。</p>
<p>枚举三角形的三条边并通过三维差分计算即可，时间复杂度 $O(n^3)$。</p>
<hr>
<blockquote>
<p>例题 $15$：[AGC 005 D] ~K Perm Counting</p>
<p>求 $1,\ldots,n$ 的排列 $p_1,\ldots,p_n$ 的数量，使得 $|i-p_i|\ne k$。</p>
<p>$O(n^2)$。</p>
</blockquote>
<p>容斥，考虑钦定 $u$ 个满足 $|i-p_i|=k$ 的方案数。</p>
<p>我们建立一张二分图，左边的点 $i$ 连到右边的点 $i+k$ 和 $i-k$，那么这个方案数就是我们要钦定在这张图上选择 $u$ 条边构成匹配。</p>
<p>可以发现这个二分图是 $2k$ 条链（或不足），假设一条链包含 $b$ 条边，要选择 $a$ 条互不相邻的边，枚举最后一条边选不选，然后将前面选的边和其下面一条一定不能选的边打包，可以得到方案数为：</p>
<script type="math/tex; mode=display">
\binom {b-a}{a}+\binom {b-1-a+1}{a-1}=\binom {b-a+1}{a}</script><p>而我们有 $2k$ 条链，只需做个背包，将它们整合到一起即可。</p>
<p>时间复杂度为 $O(n^2)$。</p>
<hr>
<blockquote>
<p>例题 $16$：[ARC 101 C] Ribbons on Tree</p>
<p>将给定的包含偶数 $n$ 个点的树上的点两两配对，使得每对点之间路径的并集包含了每一条树边，求方案数。</p>
</blockquote>
<p>容斥，考虑枚举一个边集 $E$ 求 $E$ 中所有边没有被任何路径经过的方案数。</p>
<p>删除 $E$ 中的边后树分成 $|E|+1$ 个连通块，显然 $E$ 中的边都不被经过等价于任何一对点都在同一连通块中。</p>
<p>那么每个连通块独立，设一个连通块大小为 $m$，随意钦定一个顺序，让每个没被之前选过的点选择一个其他点结队，方案数显然是 $(n-1)!!$。</p>
<p>接下来树形 DP，用 $f(i,j)$ 表示 $i$ 子树中 $i$ 所在连通块大小为 $j$ 时的容斥系数之和，这是一个简单的树形背包，注意 $f(i,0)$ 表示 $i$ 到父亲的边不被覆盖的方案，需要特殊计算。</p>
<p>时间复杂度为 $O(n^2)$。 </p>
<hr>
<h3 id="二项式反演"><a href="#二项式反演" class="headerlink" title="二项式反演"></a>二项式反演</h3><p>上面介绍的容斥原理只能用来求一些集合的并的大小，我们可以将这个东西特殊化以后进行一下扩展：</p>
<p><strong>问题：有 $n$ 个集合 $S_1,\ldots,S_n$，我们要求其中属于恰好某指定 $k$ 个集合的元素数量，并且任选 $k$ 个集合算出来的答案是一样的。</strong></p>
<p>不难发现，错排问题等只是该问题当 $k=0$ 时的特例。</p>
<p>我们设问题的答案为 $g_k$，考虑先求出一个 $f_k$，表示<strong>至少属于某指定 $k$ 个集合的元素数量</strong>，那么枚举实际上属于几个集合，有：</p>
<script type="math/tex; mode=display">
f_k=\sum\limits_{i=k}^n g_i\times \binom i k</script><p>现在我们使用容斥来推出 $g_k$，考虑使用 $f_i$ 容斥，通过枚举指定 $k$ 个集合构成的集合 $S$ 的超集：</p>
<script type="math/tex; mode=display">
g_k=\sum\limits_{S\subseteq T} f_{|T|}\times (-1)^{|T|-k}=\sum\limits_{|T|=k}^n f_{|T|}\times \binom {|T|}{k}\times (-1)^{|T|-k}</script><p>整理一下就是：</p>
<script type="math/tex; mode=display">
g_k=\sum\limits_{i=k}^nf_i\times \binom i k\times (-1)^{i-k}</script><p>通过 $f_k$ 的表达式推出 $g_k$ 关于 $f_i$ 的表达式，上面这个过程就是<strong>二项式反演</strong>。</p>
<p>二项式反演还有另一形式：</p>
<script type="math/tex; mode=display">
f_k=\sum\limits_{i=0}^k g_i\times \binom k i \\
g_k=\sum\limits_{i=0}^k f_i\times \binom k i\times (-1)^{k-i}</script><p>这个式子中，$f_k$ 的实际意义是<strong>至多属于某指定 $k$ 个集合的元素数量</strong>。</p>
<p>也就是说，二项式反演能够帮我们完成至少到恰好，或者至多到恰好的转化。</p>
<p>然而上面所展示的并非二项式反演最令人惊叹的部分，事实上我们有：</p>
<script type="math/tex; mode=display">
f_k=\sum\limits_{i=0}^k g_i\times \binom k i\times (-1)^i \\
g_k=\sum\limits_{i=0}^k f_i\times \binom k i\times (-1)^i</script><p>这个式子非常对称，并且想要证明是很容易的：令 $g’_k=g_k\times (-1)^k$，就变成了上面的形式。</p>
<p>而关于它的本质我想等到继续学了线性算法和其他反演理论之后再回来写。</p>
<hr>
<blockquote>
<p>例题 $17$：[Luogu P6596] How Many of Them</p>
<p>求 $n$ 个点的带标号无向连通图中有多少个的割边数不大于 $m$。</p>
</blockquote>
<p>这里我们需要求“至多”，而钦定“至少”是容易的，所以我们将“至多”转化为“恰好”，再将“恰好”转化为“至少”。</p>
<p>考虑求出至少 $m$ 条割边的方案数，这里需要一点生成函数的知识，首先 $m$ 条割边把图分成 $m+1$ 个部分，假设大小分别为 $a_1,\ldots,a_{m+1}$，那么通过割边将它们连接的方案数为 $n^{m-1}\times \prod\limits_{i=1}^{m+1}a_i$，而本题中点有标号，故采用 EGF 进行计算，具体地，一个部分的 EGF 设为：</p>
<script type="math/tex; mode=display">
F(x)=\sum\limits_{i=1}^n \dfrac{nix^i}{i!}</script><p>则我们要求的至少 $k$ 条边的方案是：</p>
<script type="math/tex; mode=display">
n^{-2}n![x^n]\dfrac{F^k(x)}{k!}</script><p>随后使用二项式反演导出至多 $k$ 条边的方案。</p>
<p>事实上，可以使用 NTT 将时间复杂度优化到至少 $O(n^2\log n)$。</p>
<hr>
<blockquote>
<p>例题 $18$：[NOI Online #2 提高组] 游戏</p>
<p>一棵 $2m$ 个点的有根树上有 $m$ 个黑点和 $m$ 个白点，对于每个 $k$ 求将黑点和白点两两匹配的方案数，使得恰有 $k$ 对点为祖先关系。</p>
</blockquote>
<p>通过二项式反演将“恰好”转化为“至少”，即计算钦定 $k$ 对祖先关系的方案数 $f_k$。</p>
<p>这可以通过一个树形 DP 求出，令 $f(u,k)$ 表示 $u$ 的子树中钦定 $k$ 对祖先匹配的方案数，这样设计状态是足够的，因为根据 $k$ 以及 $u$ 子树内的黑白点数量，可以知道剩余的黑白点数量，转移即树形背包，并在子树根结点处处理根和子树中点的匹配。</p>
<p>时间复杂度为 $O(m^2)$。</p>
<hr>
<blockquote>
<p>例题 $19$：[CF 1228 E] Another Filling the Grid</p>
<p>给 $n\times n$ 矩形中每个格子填上一个 $[1,k]$ 中的整数，使得每行每列的最小值都为 $1$。</p>
</blockquote>
<p>这有些像错排问题，但是情况是二维的，本质也是一个 $k=0$ 的二项式反演。</p>
<p>容斥，考虑钦定有 $a$ 行和 $b$ 列的最小值不是 $1$，那么方案数就是：</p>
<script type="math/tex; mode=display">
f(a,b)=\binom n a\times \binom n b\times (k-1)^{an+bn-ab}\times k^{n^2+ab-an-bn}</script><p>再设恰有 $a$ 行 $b$ 列的最小值不是 $1$ 的方案数为 $g(a,b)$，我们要求 $g(0,0)$，先列出 $f,g$ 的关系：</p>
<script type="math/tex; mode=display">
f(a,b)=\sum\limits_{i=a}^n\sum\limits_{j=b}^ng(i,j)\times\binom i a\times \binom j b</script><p>这里我们需要借助二维的二项式反演，我们可以将两个求和分步反演，令 $h(a,b)$ 表示钦定 $a$ 行，并恰好 $b$ 列的最小值不是 $1$，则 $h$ 和 $f$ 之间是关于列一维的二项式反演，而 $h$ 和 $g$ 之间是关于行一维的二项式反演：</p>
<script type="math/tex; mode=display">
h(a,b)=\sum\limits_{j=b}^n f(a,j)\times \binom j b\times (-1)^{j-b} \\
g(a,b)=\sum\limits_{i=a}^n h(i,b)\times \binom i a\times (-1)^{i-a}</script><p>综合起来就有：</p>
<script type="math/tex; mode=display">
g(a,b)=\sum\limits_{i=a}^n\sum\limits_{j=b}^n f(i,j)\times \binom i a\times \binom j b\times (-1)^{i+j-a-b}</script><p>而 $g(0,0)$ 就是我们所要求的。</p>
<p>时间复杂度为 $O(n^2)$。</p>
<p>题目中这种二项式反演的扩展情形在更高维也是成立的，因为 $\sum$ 可以分步反演。</p>
<hr>
<h3 id="莫比乌斯反演"><a href="#莫比乌斯反演" class="headerlink" title="莫比乌斯反演"></a>莫比乌斯反演</h3><p>这里只介绍一些莫比乌斯反演的基本内容，其他数论求和内容不在这里写。</p>
<p>一般反演的套路就是在前缀和与差分之间转化，例如<strong>自然的前缀和与差分之间就是反演，二项式反演可以看作一种“二项前缀和”和“二项差分”的转化，而莫比乌斯反演是 Dirichlet 前缀和与 Dirichlet 差分的转化。</strong></p>
<p>设有数论函数 $g_i$ 和 $f_i$，如果满足：</p>
<script type="math/tex; mode=display">
f_k=\sum\limits_{d|k}g_d</script><p>那么称 $f$ 是 $g$ 的 Dirichlet 前缀和，$g$ 是 $f$ 的 Dirichlet 差分。</p>
<p>我们可以找到很多数论中这种运算与多项式乘法之间的关系，例如 Dirichlet 前缀和实际上就是将一个函数 $g$ 与 $1$ 函数 $1(n)=1$ 进行 Dirichlet 卷积（其实就是高维多项式卷积）的结果，一如前缀和可以看成一个函数与 $\dfrac{1}{1-x}$ 的卷积，事实上 <strong>Dirichlet 前缀和就是高维前缀和</strong>。</p>
<p>设 $k$ 有 $c$ 个素因子 $p_1,\ldots,p_c$，回忆 $c$ 维函数 $F(a_1,\ldots,a_c)$ 的前缀和，其差分为：</p>
<script type="math/tex; mode=display">
G(a_1,\ldots,a_c)=\sum\limits_{S\subseteq [c]} F(a_1-[1\in S],\ldots,a_c-[c\in S])\times (-1)^{|S|}</script><p>将它套到数论背景上，我们定义莫比乌斯函数 $\mu(k)$：如果 $k$ 是一个 Square-Free Number（没有平方因子），那么若 $k$ 有奇数个素因子则 $\mu(k)=-1$，否则 $\mu(k)=1$；如果 $k$ 有平方因子，那么 $\mu(k)=0$。</p>
<p>于是，我们会看到：</p>
<script type="math/tex; mode=display">
g_k=\sum\limits_{d|k}f_d\times \mu(\dfrac{k}{d})</script><p>这就是<strong>莫比乌斯反演</strong>，这和上面的高维差分是等价的，这告诉我们数论函数的 Dirichlet 差分由它与莫比乌斯函数卷积得到。</p>
<p>类似二项式反演，对于后缀和也有类似的莫比乌斯反演形式：</p>
<script type="math/tex; mode=display">
f_k=\sum\limits_{d|k}g_d \\
g_k=\sum\limits_{d|k}f_d\times \mu(\dfrac{d}{k})</script><p>通过埃氏筛法，我们可以在 $O(n\log\log n)$ 的时间内计算 Dirichlet 前缀和与 Dirichlet 差分，但这与本文无关。</p>
<p>相关理论后续会用 Bell 级数进一步说明。</p>
<hr>
<p>例：求证 $\varphi=\mu <em> id, id=\varphi </em> 1$，其中 $*$ 是 Dirichlet 卷积，$id(n)=n$。</p>
<p>证明：</p>
<p>设全集 $U=[n]$，用容斥原理计算 $\varphi(n)$。</p>
<p>设 $n=\prod\limits_{i=1}^m p_i^{c_i}$，再设 $S_i$ 表示满足 $p_i|k$ 的不超过 $n$ 的正整数 $k$ 的集合，我们要求 $|\overline{\bigcup\limits_{i=1}^n S_i}|$。</p>
<p>若干个 $S_i$ 的交就等于 $n$ 除以它们对应 $p_i$ 的乘积，而大小为 $c$ 的子集容斥系数为 $(-1)^c$，正好等于这些 $p_i$ 乘积的莫比乌斯函数，所以：</p>
<script type="math/tex; mode=display">
\varphi(n)=\sum\limits_{d|n}\mu(d)\times \dfrac{n}{d}</script><p>也就是 $\varphi=\mu<em>id$ 了，也就是说欧拉函数是恒等函数的 Dirichlet 差分，那么 $id$ 就是 $\varphi$ 的 Dirichlet 前缀和，也即 $id=\varphi</em>1$。</p>
<hr>
<p>例：求证 $\mu *1=\varepsilon$，其中 $\varepsilon(n)=[n=1]$。</p>
<p>不难发现 $\varepsilon(n)$ 是数论函数关于 Dirichlet 卷积的单位元，而所谓 $\mu*1$ 可以理解成先将单位元差分，再前缀和，当然保持不变。</p>
<p>这个式子是大多数数论函数求和题的核心式子，我们通常通过这个式子将 $\gcd(a,b)=d$ 转化成 $d|gcd(a,b)$。</p>
<hr>
<h3 id="Min-Max-容斥"><a href="#Min-Max-容斥" class="headerlink" title="Min-Max 容斥"></a>Min-Max 容斥</h3><p>Min-Max 容斥是一种将集合最大值用其子集最小值表示的方法，当然由于相对全体实数来说，Min 和 Max 这两种运算是对称的，所以反过来也成立。</p>
<p>设有数集 $S$，令 $\max(S),\min(S)$ 分别表示其中最大值和最小值，那么有：</p>
<script type="math/tex; mode=display">
\max(S)=\sum\limits_{\varnothing\ne T\subseteq S} (-1)^{|T|-1} \min(T)</script><p>对此我们可以用普通的容斥原理来解释当 $S$ 为正整数集的情形：设 $S=\{S_1,\ldots,S_m\}$，令 $T_i$ 表示不大于 $S_i$ 的正整数集合，则 $\max(S)=|\bigcup T_i|$，而 $\min(S)=|\bigcap T_i|$，上面的式子显然就是容斥原理换了个皮。</p>
<p>对于一般情况，有一种容易理解的解释：考虑 $x\in S$，设有 $t(x)$ 个数比它大，那么在右边就计算了 $\displaystyle\sum\limits_{i=0}^{t(x)}(-1)^i\binom {t(x)} i=[t(x)=0]$ 次，所以只有最大值被保留下来。</p>
<p>由于 $\max(S)=-\min(-S)$（$-S$ 是 $S$ 中所有数取相反数得到的集合），所以也有：</p>
<script type="math/tex; mode=display">
\min(S)=\sum\limits_{\varnothing\ne T\subseteq S} (-1)^{|T|-1} \max(T)</script><p>到这里，观察普通的容斥和 Min-Max 容斥，我们已经注意到了：</p>
<ul>
<li>针对集合的普通容斥中，<strong>包含</strong>是定义在集合上的偏序关系，而交并分别是取下界和上界；</li>
<li>针对实数的 Min-Max 容斥中，<strong>不大于</strong>是定义在实数集合上的偏序关系，而 $\min,\max$ 分别是取下界和上界。</li>
</ul>
<p>所以也许我们能将这样的式子推广到其他偏序上去，例如：</p>
<p>由整数的整除偏序可以导出 <strong>GCD-LCM 容斥</strong>：</p>
<script type="math/tex; mode=display">
\gcd(S)=\prod\limits_{\varnothing\ne T\subseteq S}(\operatorname{lcm}(T))^{(-1)^{|T|-1}} \\
\operatorname{lcm}(S)=\prod\limits_{\varnothing\ne T\subseteq S}(\gcd(T))^{(-1)^{|T|-1}}</script><p>当然这里举的例子并没有什么用，因为这本质上只是<strong>高维的 Min-Max 容斥</strong>。</p>
<p>上面这段可以当成我的胡说八道，实际上只有一个偏序集的任何一个子集有上下确界并且能定义加减运算时才有可能成立。</p>
<hr>
<p>接下来考虑更进一步，如何用子集的 $\min$ 表示一个集合的第 $k$ 大数，先给出结论：</p>
<script type="math/tex; mode=display">
\operatorname{max}_k(S)=\sum\limits_{T\subseteq S,|T|\ge k}(-1)^{|T|-k}\times\binom {|T|-1}{k-1}\times \min(T)</script><p>证明同样考虑贡献，由于 $|T|\ge k$，所以比第 $k$ 大数更大的数一定不会在右边出现。</p>
<p>然后，考虑第 $l&gt;k$ 大的数的贡献，它是：</p>
<script type="math/tex; mode=display">
\sum\limits_{i=k}^{l}(-1)^{i-k}\times \binom {i-1}{k-1}\times \binom {l-1}{i-1}=\binom {l-1}{k-1}\times \sum\limits_{i=k}^l(-1)^{i-k}\times \binom {l-k}{i-k}</script><p>这个等式之前二项式系数漏写了，通过组合意义证明：从 $l-1$ 个里面选 $i-1$ 个，再从这 $i-1$ 个里选 $k-1$ 个，等价于先直接选 $k-1$ 个，再从没选的 $l-k$ 个里补出来 $i-k$ 个。</p>
<p>后面这个我们就比较熟悉了，它和基本的 Min-Max 容斥一样，只有 $l=k$ 时才为 $1$，因此上面的式子成立。</p>
<p>当然，式子中的 $\min$ 和 $\max$ 互换也是正确的。</p>
<hr>
<p>Min-Max 容斥的一个常见用途也是将“完全”转化为“至少”，假设有 $n$ 个事件，我们需要计算它们全部发生的期望时间，可以转化为计算某个子集至少发生一件的期望时间。</p>
<hr>
<blockquote>
<p>例题 $20$：[Luogu P4707] 重返现世</p>
<p>有 $n$ 种原料，每秒随机生成一种，生成第 $i$ 种的概率为 $\dfrac{p_i}{m} (m=\sum p_i)$，问第一次集齐 $k$ 种原料的期望时间。</p>
<p>$O(n(n-k)m)$。</p>
</blockquote>
<p>设第 $i$ 种原料在时间 $t_i$ 第一次被收集到，我们要求 $t_i$ 中的第 $q=n-k+1$ 大数的期望。</p>
<p>套用 Min-Max 容斥，我们得到：</p>
<script type="math/tex; mode=display">
\operatorname{max}_q(S)=\sum\limits_{T\subseteq S,|T|\ge q}(-1)^{|T|-q}\times\binom {|T|-1}{q-1}\times \min(T)</script><p>而 $\min(T)$ 表示第一次收集到 $T$ 中原料的期望时间，也就是说之前只有其他的原料，所以有：</p>
<script type="math/tex; mode=display">
S=\dfrac{\sum\limits_{i\notin T}p_i}{m},\quad \min(T)=\dfrac{1}{1-S}=\dfrac{m}{\sum\limits_{i\in T}p_i}</script><p>那么我们可以设计一个背包，令 $dp(i,j,k)$ 表示前 $i$ 个原料中大小为 $j$，且其 $\sum p=k$ 时的集合数量，转移显然：</p>
<script type="math/tex; mode=display">
dp(i,j,k)\leftarrow dp(i-1,j,k)+dp(i-1,j-1,k-p_i)</script><p>时间复杂度是 $O(n^2m)$ 的。</p>
<p>下面就需要优化了，一般这种 DP 的优化思路就是<strong>将一部分系数通过组合意义或组合恒等式化到 DP 值中去</strong>，这里我们就进行这样的尝试，设：</p>
<script type="math/tex; mode=display">
f(i,j,k)=\sum\limits_{T\subseteq \{p_1,\ldots,p_i\},\sum\limits_{j\in T}p_t=j}(-1)^{|T|-k}\times \binom {|T|-1}{k-1}</script><p>也就是说，前 $i$ 个原料的所有 $\sum p=j$ 的子集的后面这个式子的和，我们将 $|T|$ 计入 DP 值，从而将一个大小为 $n$ 的维度替换成了大小仅为 $q=n-k+1$ 的维度。</p>
<p>转移时，考虑到 $(-1)^{|T|-k}\displaystyle \binom {|T|-1}{k-1}=(-1)^{|T|-1-k+1}\binom {|T|-2}{k-1}+(-1)^{|T|-2-k}\binom {|T|-2}{k-2}$，所以有：</p>
<script type="math/tex; mode=display">
f(i,j,k)\leftarrow f(i-1,j,k)+f(i-1,j-p_i,k-1)-f(i-1,j-p_i,k)</script><p>时间复杂度为 $O(n(n-k)m)$。</p>
<hr>
<blockquote>
<p>例题 $22$：[HAOI 2015] 按位或</p>
<p>有一个初始为 $0$ 的数 $x$，每秒按照数 $i$ 权重 $p_i$ 来随机选择一个 $[0,2^n-1]$ 中的数，然后将 $x$ 或上这个数，求第一次 $x$ 变为 $2^n-1$ 的期望时间。</p>
</blockquote>
<p>设 $t_i$ 表示第 $i$ 个二进制位第一次在 $x$ 中为 $1$ 的期望时间，我们要求 $\max(t_i)$ 的期望，根据 Min-Max 容斥只要对子集 $T$ 计算 $\min(T)$ 的期望。</p>
<p>和上题类似，每次只能选择不在 $T$ 中的位，所以有：</p>
<script type="math/tex; mode=display">
\min(T)=\dfrac{1}{1-\sum\limits_{S\cap T=\varnothing}p_S}</script><p>只需要计算一个子集和即可，使用 FWT 即可算出。</p>
<p>时间复杂度为 $O(n\times 2^n)$。</p>
<hr>
<blockquote>
<p>例题 $21$：[PKUWC 2018] 猎人杀</p>
<p>按如下规则构造 $1,\ldots,n$ 的排列：每次从未被选择的元素中以第 $i$ 个元素 $p_i$ 的权重随机选择一个，求 $1$ 是最后一个的概率。</p>
</blockquote>
<p>好吧，我的理解里这题和 Min-Max 容斥有点不大像，但还是放这里写一下。</p>
<p>考虑容斥，枚举排在 $1$ 后面的数的集合 $S$，此时可以忽略其他数，$1$ 排在 $\{1\}\cup S$ 中的第一个，这个概率显然是 $\dfrac{p_1}{p_1+\sum\limits_{j\in S}p_j}$。</p>
<p>然后我们可以背包一下，算出不包含 $1$ 的子集中所有 $\sum p_j=x$ 的容斥系数之和 $f(x)$，做个背包即可实现。</p>
<p>时间复杂度为 $O(n\times \sum p_i)$，如果要继续优化可以使用分治 NTT。</p>
<hr>
<h2 id="4-生成函数"><a href="#4-生成函数" class="headerlink" title="4. 生成函数"></a>4. 生成函数</h2><p><strong>不写 FFT。</strong></p>
<hr>
<h3 id="从形式幂级数谈起"><a href="#从形式幂级数谈起" class="headerlink" title="从形式幂级数谈起"></a>从形式幂级数谈起</h3><p>对于数列 $f_i (i\in \mathbb{N})$，定义其<strong>形式幂级数</strong> $F(x)$ 为：</p>
<script type="math/tex; mode=display">
F(x)=\sum\limits_{i=0}^{+\infty} f_ix^i</script><p>与一般意义上的多项式不同，形式幂级数允许无限项的求和，而在数学推导后对各种操作进行实现时，我们通常只能取其前 $n$ 项进行计算，此时应表示成：</p>
<script type="math/tex; mode=display">
F(x)\bmod x^n</script><p>以表示 $F(x)$ 的 $0$ 到 $n-1$ 次项组成的多项式。</p>
<p>$F(x)$ 只是 $f_i$ 的一种表现形式，在进行各种运算时，我们均假定 $F(x)$ 收敛。</p>
<p>定义形式幂级数的几个基本运算如下（多项式运算的扩展），设 $A(x)=\sum\limits_{i=0}^{+\infty}a_ix^i, B(x)=\sum\limits_{i=0}^{+\infty}b_ix^i$：</p>
<ol>
<li><p><strong>两形式幂级数相等：</strong></p>
<script type="math/tex; mode=display">
A(x)=B(x)\Leftrightarrow \forall i\in \mathbb{N},\ a_i=b_i</script><p>即两个幂级数每一项的系数都相等。</p>
</li>
<li><p><strong>两形式幂级数相加减：</strong></p>
<script type="math/tex; mode=display">
A(x)\pm B(x)=\sum\limits_{i=0}^{+\infty} (a_i\pm b_i)x^i</script><p>容易发现，形式幂级数加法具有交换律和结合律，且 $0$ 为加法单位元。</p>
</li>
<li><p><strong>两形式幂级数相乘（卷积）：</strong></p>
<script type="math/tex; mode=display">
(A*B)(x)=\sum\limits_{i=0}^{+\infty}(\sum\limits_{j=0}^ia_jb_{i-j})x^i</script><p>和多项式乘法的定义基本相同，只是拓展到了无限项。</p>
<p>容易发现，形式幂级数卷积具有交换律，结合律以及对加法的分配率，且 $1$ 为乘法单位元，如果两个形式幂级数 $A(x),B(x)$ 的乘积在 $\bmod x^n$ 意义下为 $1$，则称它们在 $\bmod x^n$ 的意义下互为<strong>乘法逆元</strong>。</p>
</li>
<li><p><strong>形式幂级数求导：</strong></p>
<script type="math/tex; mode=display">
A'(x)=\sum\limits_{i=0}^{+\infty}(i+1)a_{i+1}x^i</script><p>导函数 $A’(x_0)$ 也写为 $\dfrac{\mathrm{d}A}{\mathrm{d}x}(x_0)$，高阶导数写作 $A^{(k)}(x)$，即 $A^{(k)}(x)=(A^{(k-1)})’(x)$。</p>
<p>加法运算：$(A+B)’=A’+B’$；</p>
<p>乘法运算：$(AB)’=A’B+AB’$；</p>
<p>复合运算：$\dfrac{\mathrm{d}B}{\mathrm{d}x}=\dfrac{\mathrm{d}B}{\mathrm{d}A}\times \dfrac{\mathrm{d}A}{\mathrm{d}x}$，即若 $C(x)=B(A(x))$，则 $C’(x)=B’(A(x))A’(x)$。</p>
</li>
<li><p><strong>形式幂级数积分：</strong></p>
<script type="math/tex; mode=display">
\int A(x)\mathrm{d}x=\Big(\sum\limits_{i=1}^{+\infty}\dfrac{a_{i-1}}{i}x^i\Big)+C</script><p>此为不定积分，定积分类似，设 $B(x)=\displaystyle\int A(x)\mathrm{d}x$，则 $\displaystyle\int_{x_1}^{x_2} A(x)\mathrm{d}x=B(x_2)-B(x_1)$。</p>
<p>所以，如果要去除最后的常数 $C$，应该计算 $\displaystyle\int_0^{x_0}A(x)\mathrm{d}x$。</p>
<p>求导和积分互为逆运算，但是注意求导后积分可能会失去常数项信息。</p>
</li>
</ol>
<p>考虑在 $\bmod x^n$ 的意义下实现以上运算，加减法以及导数积分都是可以轻松做到 $O(n)$ 的，而计算卷积时可以利用 FFT，做到 $O(n\log n)$ 的复杂度。</p>
<hr>
<h3 id="泰勒展开和牛顿迭代"><a href="#泰勒展开和牛顿迭代" class="headerlink" title="泰勒展开和牛顿迭代"></a>泰勒展开和牛顿迭代</h3><p>没学过数分，一堆东西不会证明。</p>
<p>对于一个解析式和图像可能比较奇怪或难以处理的函数 $G(x)$，我们选取一点 $x_0$，采用一个形式幂级数 $F(x)$ 来在 $x_0$ 的某一邻域内拟合 $G(x)$ 的图像，这个过程就叫做<strong>泰勒展开</strong>。</p>
<p>更具体地说，对于曲线 $G(x)$，如果它在 $x=x_0$ 处具有 $n$ 阶导数，那么可以用关于 $x-x_0$ 的 $n$ 次多项式 $F(x)$ 来在 $x_0$ 的某一邻域内逼近 $G(x)$ 的值，泰勒公式保证了 $G(x)-F(x)$ 是 $(x-x_0)^n$ 的高阶无穷小。</p>
<p>我们先从较简单的形式开始，先令 $x_0=0$。</p>
<p>考虑形式幂级数 $F(x)$ 的各阶导数，我们希望对于任意 $i\in [0,n]$ 中的整数，都有 $F^{(i)}(0)=G^{(i)}(0)$。</p>
<p>先考虑 $n$ 阶导数（设 $a_i$ 为 $F(x)$ 的各项系数）：</p>
<script type="math/tex; mode=display">
F^{(n)}(0)=n\times (n-1)\times \ldots\times 1\times a_n=G^{(n)}(0)</script><p>所以我们可以得到：</p>
<script type="math/tex; mode=display">
a_n=\dfrac{G^{(n)}(0)}{n\times (n-1)\times \ldots\times 1}=\dfrac{G^{(n)}(0)}{n!}</script><p>类似地，再考虑 $n-1$ 阶导数：</p>
<script type="math/tex; mode=display">
F^{(n-1)}(0)=(n-1)!a_{n-1}+\dfrac{n!}{1!}a_n\times 0=(n-1)!a_{n-1}=G^{(n-1)}(0)</script><p>所以我们可以得到：</p>
<script type="math/tex; mode=display">
a_{n-1}=\dfrac{G^{(n-1)}(0)}{(n-1)!}</script><p>以此类推，我们可以得到，对于每一个 $i\in [0,n]\cap \mathbb{Z}$，都有 $a_i=\dfrac{G^{(i)}(0)}{i!}$，所以：</p>
<script type="math/tex; mode=display">
F(x)=\sum\limits_{i=0}^n \dfrac{G^{(i)}(0)}{i!}x^i</script><p>当 $n\to +\infty$ 时，即：</p>
<script type="math/tex; mode=display">
F(x)=\sum\limits_{i=0}^{+\infty} \dfrac{G^{(i)}(0)}{i!}x^i</script><p>这个式子是泰勒展开 $x_0=0$ 的特殊情形，称为<strong>麦克劳林公式</strong>。</p>
<p>当 $x_0\ne 0$ 时，我们只需将新的 $F(x)$ 设为原来的 $F(x-x_0)$ 即可，因为我们只需要保证求 $i$ 次导时只有 $i$ 次项系数会影响结果，那么将原来的 $x$ 换成 $(x-x_0)$ 后恰有 $F(x)$ 中每个 $(x-x_0)^i (i&gt;0)$ 都是 $0$，所以：</p>
<script type="math/tex; mode=display">
F(x)=\sum\limits_{i=0}^{+\infty} \dfrac{G^{(i)}(x_0)}{i!}(x-x_0)^i</script><p>当 $n$ 趋于无穷时，我们就可以认为在 $x_0$ 的某一邻域内，$G(x)=F(x)$，但是形式幂级数的研究基于 $F(x)$ 收敛的假设，所以我们不考虑 $G(x)-F(x)$ 是否发散，当成收敛来处理。</p>
<ol>
<li><p><strong>指数函数 $G(x)=e^x$。</strong></p>
<p>由于 $(e^x)’=e^x$，所以 $G^{(i)}(x)=G(x)=e^x$，取 $x_0=0$，则 $G^{(i)}(x)=1$，因此：</p>
<script type="math/tex; mode=display">
e^x=\sum\limits_{i=0}^{+\infty}\dfrac{x^i}{i!}</script><p>当我们取 $x=1$ 时，即可以得到一个非常常见的关于 $e$ 的等式：$e=\sum\limits_{i=0}^{+\infty} \dfrac{1}{i!}$。</p>
</li>
<li><p><strong>对数函数 $G(x)=\ln (x)$。</strong></p>
<p>由于 $(\ln (x))’=\dfrac{1}{x}$，接下来再根据 $x^{\mu}$ 的求导法则即可得到 $G^{(i)}(x)=(-1)^{i-1}\times (i-1)!\times x^{-i}$，其中的 $(i-1)!$ 可以与泰勒展开中的 $i!$ 抵消，只剩下了 $\dfrac{1}{i}$。</p>
<p>我们取 $x_0=1$ 进行展开（因为 $\ln (x)$ 在 $x=0$ 处不存在导数）：</p>
<script type="math/tex; mode=display">
\ln (x)=\sum\limits_{i=1}^{+\infty}(-1)^{i-1}\dfrac{(x-1)^i}{i}</script><p>稍作变换即可得到一个我们更为熟悉的式子：</p>
<script type="math/tex; mode=display">
\ln (1+x)=\sum\limits_{i=1}^{+\infty}(-1)^{i-1}\dfrac{x^i}{i}</script></li>
<li><p><strong>正弦/余弦函数 $G(x)=\sin (x)$ 及 $G(x)=\cos (x)$。</strong></p>
<p>对正弦或余弦函数求导，我们可以得到一个循环：$\sin\to \cos\to -\sin\to -\cos\to \sin\to \cdots$。</p>
<p>取 $x_0=0$，则 $\sin (x_0)=0, \cos(x_0)=1$，在 $\sin (x)$ 展开式中，就只有奇数次项是与 $\cos$ 有关的，而与 $\sin$ 有关的直接根据 $\sin(x_0)=0$ 忽略，在 $\cos(x)$ 中同理只有偶数次项和 $\cos$ 有关，所以：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\sin(x)=\sum\limits_{i=0}^{+\infty}(-1)^i\dfrac{x^{2i+1}}{(2i+1)!}=x-\dfrac{x^3}{3!}+\dfrac{x^5}{5!}-\cdots \\
\cos(x)=\sum\limits_{i=0}^{+\infty}(-1)^i\dfrac{x^{2i}}{(2i)!}=1-\dfrac{x^2}{2!}+\dfrac{x^4}{4!}-\cdots
\end{aligned}</script></li>
</ol>
<p>两个幂级数的复合运算定义如下：</p>
<p>若 $A(x)=\sum\limits_{i=0}^{+\infty}a_ix^i, B(x)=\sum\limits_{i=0}^{+\infty}b_ix^i, C(x)=(B\circ A)(x)$ 或写作 $B(A(x))$，则：</p>
<script type="math/tex; mode=display">
C(x)=\sum\limits_{i=0}^{+\infty} b_i(\sum\limits_{j=0}^{+\infty} a_jx^j)^i</script><p>注意，两个函数的复合有意义，当且仅当 $B$ 仅有有限多项，或 $a_0=0$。</p>
<p>有时我们会遇到这样的问题：给定一个幂级数 $B(x)\bmod x^n$，求出一个幂级数 $A(x)\bmod x^n$ 使得：</p>
<script type="math/tex; mode=display">
(B\circ A)(x)\equiv 0\bmod x^n</script><p>处理这样的问题的一种通用方法就是牛顿迭代法。</p>
<p>首先假设我们通过某种方式求出了 $n=1$ 时的答案（即确定了常数项），在实际运用中这通常是容易的。</p>
<p>当 $n&gt;1$ 时，我们先递归求解出 $\lceil \dfrac{n}{2}\rceil $ 时的答案（接下来为了方便书写，省略了上取整），称为 $A_0(x)$，即：</p>
<script type="math/tex; mode=display">
B(A_0(x))\equiv 0\bmod x^{\frac{n}{2}}</script><p>接下来考虑对 $(B\circ A)(x)$ 这个复合函数在 $A_0(x)$ 处进行泰勒展开：</p>
<script type="math/tex; mode=display">
(B\circ A)(x)=\sum\limits_{i=0}^\infty \dfrac{B^{(i)}(A_0(x))}{i!}(A(x)-A_0(x))^i</script><p>这个式子看似棘手，实际上方便处理。因为我们有 $A(x)\equiv A_0(x)\bmod x^{\frac{n}{2}}$（根据 $A_0(x)$ 的假设而来），移项后平方，得到：</p>
<script type="math/tex; mode=display">
(A(x)-A_0(x))^2\equiv 0\bmod x^n</script><p>因此上面的展开式中大于等于二次的项都可以忽略了（在 $\bmod x^n$ 意义下为 $0$），也就是说：</p>
<script type="math/tex; mode=display">
B(A(x))\equiv B(A_0(x))+B'(A_0(x))(A(x)-A_0(x))\bmod x^n</script><p>而条件是 $B(A(x))\equiv 0\bmod x^n$，所以：</p>
<script type="math/tex; mode=display">
B(A_0(x))+B'(A_0(x))A(x)-B'(A_0(x))A_0(x)\equiv 0\bmod x^n</script><p>这里面只有 $A(x)$ 是未知量，解得：</p>
<script type="math/tex; mode=display">
A(x)\equiv A_0(x)-\dfrac{B(A_0(x))}{B'(A_0(x))} \bmod x^n</script><p>就建立了从 $A_0(x)$ 到 $A(x)$ 的过程，迭代这一过程即可求解原先的 $A(x)$。</p>
<hr>
<h3 id="常见运算"><a href="#常见运算" class="headerlink" title="常见运算"></a>常见运算</h3><ol>
<li><p><strong>形式幂级数求逆。</strong></p>
<p>给定一个幂级数 $G(x)\bmod x^n$，求一个幂级数 $F(x)\bmod x^n$ 使得 $G(x)F(x)\equiv 1\bmod x^n$。</p>
<p><strong>不会 FFT 的做法：</strong></p>
<p>$[x^0]F(x)=\dfrac{1}{[x^0]G(x)}$，而通过 $x^m$ 项系数对比以及前面已经求出的项可以递推计算出 $[x^m]F(x)$，复杂度 $O(n^2)$。</p>
<p><strong>会 FFT 的做法：</strong></p>
<p>注意：$G(x)$ 可逆的条件是其常数项存在逆元，$[x^0]G(x)\ne 0$，那么 $F(x)$ 的常数项就是 $G(x)$ 的常数项的乘法逆元了，这是接下来迭代的下界。</p>
<p>考虑先递归求出一个 $F_0(x)$ 使得：</p>
<script type="math/tex; mode=display">
F_0(x)G(x)\equiv 1\bmod x^{\frac{n}{2}}</script><p>设 $H(F(x))=F(x)G(x)-1$，则我们要求的就是 $H(F(x))\equiv 0\bmod x^n$ 的 $F(x)$，直接套之前写过的牛顿迭代法的式子：</p>
<script type="math/tex; mode=display">
\begin{aligned}
G(x)F_0(x) & \equiv 1\bmod x^{\frac{n}{2}} \\
F(x) & \equiv F_0(x)-\dfrac{H(F_0(x))}{H'(F_0(x))}\bmod x^n
\end{aligned}</script><p>考虑 $H’(F(x))=G(x)$，而因为泰勒展开中 $H’(F_0(x))$ 后的乘积项是 $(F(x)-F_0(x))\equiv 0\bmod x^{\frac{n}{2}}$，所以我们这里的 $H’(F_0(x))$ 在 $\bmod x^n$ 意义下只有前 $\dfrac{n}{2}$ 次项有意义，由于 $G(x)\equiv \dfrac{1}{F_0(x)}\bmod x^{\frac{n}{2}}$，所以可得：</p>
<script type="math/tex; mode=display">
\begin{aligned}
F(x) & \equiv F_0(x)-(G(x)F_0(x)-1)\times F_0(x)\bmod x^n \\
F(x) & \equiv 2F_0(x)-G(x)F_0^2(x)\bmod x^n
\end{aligned}</script><p>这样迭代的时间复杂度为 $O(n\log n+\dfrac{n}{2}\log \dfrac{n}{2}+\ldots)$，内部的和式不超过 $2n\log n$，所以该算法时间复杂度为 $O(n\log n)$。</p>
</li>
<li><p><strong>形式幂级数对数函数（求 $\ln$）：</strong></p>
<p>给定一个幂级数 $G(x)\bmod x^n$，求出一个幂级数 $F(x)\bmod x^n$ 使得 $F(x)\equiv \ln(G(x))\bmod x^n$。</p>
<p>这里的 $\ln(G(x))$ 就是 $G(x)$ 与 $\ln$ 的麦克劳林级数复合。</p>
<p>注意，求 $\ln$ 时要求满足 $[x^0]G(x)=1$，否则会产生一系列问题。</p>
<p>这个问题其实比较简单，我们将上面要求的式子两边同时求导：</p>
<script type="math/tex; mode=display">
F'(x)\equiv \dfrac{G'(x)}{G(x)}\bmod x^n</script><p>注意 $\ln’(x)=\dfrac{1}{x}$，而根据链式法则做复合函数求导时不要忘记 $G’(x)$。</p>
<p>此时我们已经去掉了 $\ln$，然后两边积分还原 $F(x)$：</p>
<script type="math/tex; mode=display">
F(x_0)\equiv \int_0^{x_0}\dfrac{G'(x)}{G(x)}\mathrm{d}x</script><p>注意常数项为 $\ln(1)=0$。</p>
<p>于是我们先做一次求导，然后求一次逆，然后做一次多项式乘法，最后积分即可，时间复杂度为 $O(n\log n)$。</p>
</li>
<li><p><strong>形式幂级数指数函数（求 $\exp$）：</strong></p>
<p>给定一个幂级数 $G(x)\bmod x^n$，求出一个幂级数 $F(x)\bmod x^n$ 使得 $F(x)\equiv \exp(G(x))\bmod x^n$。</p>
<p><strong>一种 $O(n\log^2 n)$ 或 $O(n^2)$ 做法：</strong></p>
<p>两边求导，建立递推式：</p>
<script type="math/tex; mode=display">
F'(x)=\exp(G(x))G'(x) \\
F(x)+C=\int F(x)G'(x) \\
[x^0]F(x)=1</script><p>直接递推复杂度为 $O(n^2)$，利用分治 FFT 的复杂度为 $O(n\log^2 n)$。</p>
<p><strong>正常的牛顿迭代：</strong></p>
<p>同理，这里的 $\exp(G(x))$ 就是 $G(x)$ 与 $\exp$ 的麦克劳林级数复合，且基于同样的理由，要求 $[x^0]G(x)=0$。</p>
<p>考虑用牛顿迭代法解决这个问题，设 $H(F(x))=\ln (F(x))-G(x)$。</p>
<p>直接带式子：</p>
<script type="math/tex; mode=display">
\begin{aligned}
F_0(x) & \equiv \exp(G(x))\bmod x^{\frac{n}{2}} \\
F(x) & \equiv F_0(x)-\dfrac{H(F_0(x))}{H'(F_0(x))}
\end{aligned}</script><p>而 $H’(F_0(x))=\dfrac{1}{F_0(x)}$，注意这里的求导仅仅是 $\dfrac{\mathrm{d}H}{\mathrm{d}F_0}$，所以不用链式法则。</p>
<p>于是我们有：</p>
<script type="math/tex; mode=display">
\begin{aligned}
F(x) & \equiv F_0(x)-\dfrac{\ln(F_0(x))-G(x)}{\frac{1}{F_0(x)}} \\
F(x) & \equiv F_0(x)-F_0(x)\ln(F_0(x))+F_0(x)G(x) \\
F(x) & \equiv F_0(x)\Big(1-\ln(F_0(x))+G(x)\Big)
\end{aligned}</script><p>最后一个式子就是我们的目标，按照它迭代运算即可，时间复杂度分析和求逆类似，是 $O(n\log n)$。</p>
</li>
<li><p><strong>形式幂级数幂函数：</strong></p>
<p>给定一个幂级数 $G(x)\bmod x^n$ 和实数 $k$，求出一个幂级数 $F(x)\bmod x^n$ 使得 $F(x)\equiv G^k(x)\bmod x^n$。</p>
<p>思路一：倍增快速幂。</p>
<p>当 $k\in \Z^+$ 时，我们只要用倍增快速幂，每次计算一次多项式乘法即可，时间复杂度为 $O(n\log^2 n)$。</p>
<p>思路二：转化为 $\ln$ 和 $\exp$。</p>
<p>将要求的式子两边 $\ln$，得到：</p>
<script type="math/tex; mode=display">
\ln(F(x))\equiv k\ln(G(x))\bmod x^n</script><p>再 $\exp$ 回去，就得到：</p>
<script type="math/tex; mode=display">
F(x)\equiv \exp(k\ln(G(x)))\bmod x^n</script><p>所以我们做一次 $\ln$ 和一次 $\exp$ 即可。</p>
<p>但是事情还没完，我们之前说过能做 $\ln$ 的条件是常数项为 $1$，如果常数项不为 $1$，就不能直接这样做。</p>
<p>当然这个也很好处理，设 $a_ix^i$ 是 $G(x)$ 中的最低非零项，那么 $\dfrac{G(x)}{a_ix^i}$ 就是一个常数项为 $1$ 的幂级数了，我们将上面的式子稍作改写：</p>
<script type="math/tex; mode=display">
F(x)\equiv (a_ix^i)^k\times \exp(k\ln(\dfrac{G(x)}{a_ix^i}))\bmod x^n</script><p>这就解决了常数项不一定为 $1$ 的问题。</p>
<p>这个做法的时间复杂度为 $O(n\log n)$。</p>
</li>
</ol>
<hr>
<h3 id="生成函数"><a href="#生成函数" class="headerlink" title="生成函数"></a>生成函数</h3><p>对于数列 $f_n (n\in \mathbb{N})$，定义其<strong>普通型生成函数（OGF）</strong>为：</p>
<script type="math/tex; mode=display">
F(x)=\sum\limits_{i=0}^{+\infty}f_ix^i</script><p>定义其<strong>指数型生成函数（EGF）</strong>为：</p>
<script type="math/tex; mode=display">
F(x)=\sum\limits_{i=0}^{+\infty}\dfrac{f_i}{i!}x^i</script><p>生成函数是描述一个数列的方式之一，是解决数列问题的有用工具。</p>
<p>对数列的操作和变化，以及对数列的研究，可以用生成函数的运算和性质来刻画。</p>
<hr>
<h3 id="组合意义"><a href="#组合意义" class="headerlink" title="组合意义"></a>组合意义</h3><p>记两个数列 $f_n (n\in \mathbb{N}), g_n (n\in \mathbb{N})$ 的 OGF 为 $F(x), G(x)$，其中 $f_i$ 表示：<strong>用 A 方法选出 $i$ 个元素的方案数</strong>，$g_i$ 则表示：<strong>用 B 方法选出 $i$ 个元素的方案数</strong>。</p>
<p>考虑一个新数列 $h_n (n\in \mathbb{N})$，其 OGF 满足 $H(x)=F(x)\times G(x)$，考虑 $h_i$ 的组合意义：</p>
<p>根据 OGF 的定义我们知道：</p>
<script type="math/tex; mode=display">
h_n=[x^n]H(x)=\sum\limits_{i=0}^n[x^i]F(x)\times [x^{n-i}]G(x)=\sum\limits_{i=0}^nf_ig_{n-i}</script><p>而最后的 $f_ig_{n-i}$ 可以理解为：用 A 方法选出 $i$ 个元素，再用 B 方法选出 $n-i$ 个元素的方案数，再加上枚举 $i$，相当于就是：总共选出 $n$ 个元素的方案数，无论分别用 A,B 方法选了几个。</p>
<p>注意这里的元素是无标号的，也就是我们不考虑 $n$ 个元素排列的顺序。</p>
<p>所以我们可知，两个数列 OGF 相乘的组合意义是：<strong>用两种方式共选出某一数量的无标号元素（的方案数）</strong>。</p>
<p>接下来再考虑两个数列的 EGF，也记作 $F(x),G(x)$。</p>
<p>考虑一个新数列 $h_n (n\in \mathbb{N})$，其 EGF 满足 $H(x)=F(x)\times G(x)$，考虑 $h_i$ 的组合意义。</p>
<p>先写出 $h_n$ 的表达式：</p>
<script type="math/tex; mode=display">
h_n=n!\times [x^n]H(x)=n!\sum\limits_{i=0}^n[x^i]F(x)\times[x^{n-i}]G(x)=n!\sum\limits_{i=0}^n\dfrac{f_ig_{n-i}}{i!(n-i)!}</script><p>而如果我们将 $n!$ 与 $i!(n-i)!$ 组合，发现这是一个二项式系数，所以：</p>
<script type="math/tex; mode=display">
h_n=\sum\limits_{i=0}^n\binom n i f_ig_{n-i}</script><p>这个式子称为 <strong>二项卷积</strong>，其组合意义可以理解为：在 $n$ 个元素中，选出 $i$ 个用 A 方案选，另外 $n-i$ 个用 B 方案选，但和 OGF 不同的是，我们发现这里的元素是有标号的，也就是我们需要考虑用 A 方案选的元素和用 B 方案选的元素的先后次序。</p>
<p>所以我们可知，两个数列 EGF 相乘的组合意义是：<strong>用两种方式共选出某一数量的带标号元素（的方案数）</strong>。</p>
<p>那么如果是两个相同的生成函数相乘，又有什么特殊的组合意义呢？考虑 $F^2(x)$ 的组合意义，以同一方式取两次，共取走了 $n$ 个元素，我们将这个二次推广到 $n$ 次可知：$F^n(x)$ 的组合意义就是以统一方式共取 $n$ 次元素，总共取到某一数量元素的方案数，有无标号根据 EGF 还是 OGF 来决定。</p>
<p>注意指数上这个“取的次数”是带标号的，例如第一次取一个，第二次取两个和第一次取两个，第二次取一个是不同的取法。</p>
<hr>
<p>我们可以更进一步，设两个 OGF 分别为 $A(x),B(x)$ 的<strong>无标号</strong>组合类 $S,T$，其中大小为 $i$ 的对象分别有 $a_i,b_i$ 个，设 OGF 为 $C(x)$ 的<strong>无标号</strong>组合类 $R$ 满足：</p>
<ul>
<li><p>每个对象是 $S$ 或 $T$ 中的对象：$C(x)=A(x)+B(x)$；</p>
</li>
<li><p>每个对象是 $S,T$ 中各取一个的笛卡尔积：$C(x)=A(x)\times B(x)$；</p>
</li>
<li><p>每个对象是 $S$ 中若干个对象组成的序列（带标号组合）：$C(x)=\sum\limits_{i=0}^{+\infty} A^i(x)=\dfrac{1}{1-A(x)}$；</p>
</li>
<li><p>每个对象是 $S$ 中若干个对象组成的多重集（无标号组合）：</p>
<p>这个操作称为<strong>欧拉变换</strong>，记为 $\mathcal E(A(x))$，会发现这其实就是一个完全背包，考虑 DP 过程，对每个物品相当于给答案的 OGF 乘上 $(1+x^i+x^{2i}+\ldots)$，所以：</p>
<script type="math/tex; mode=display">
C(x)=\mathcal E(A(x))=\prod\limits_{i=1}^{+\infty}(1-x^i)^{-a_i}</script></li>
<li><p>每个对象是 $S$ 中若干个对象的不可重集：</p>
<p>和上面类似，只不过是 $01$ 背包：</p>
<script type="math/tex; mode=display">
C(x)=\prod\limits_{i=1}^{+\infty}(1+x^i)^{a_i}</script></li>
<li><p>每个对象是 $S$ 中某个对象中的所有元素替换为 $T$ 中的一个对象：</p>
<p>通常用于递归结构，不难发现这就是复合运算：</p>
<script type="math/tex; mode=display">
C(x)=(A\circ B)(x)</script></li>
</ul>
<p>计算方法：</p>
<p>对于前三条都可以直接计算。</p>
<p>四五条的乘积式的常见处理手法是化乘为加，例如：</p>
<script type="math/tex; mode=display">
\mathcal E(A(x))=\exp(\ln(\prod\limits_{i=1}^{+\infty}(1-x^i)^{-a_i}))=\exp(-\sum\limits_{i=1}^{+\infty} a_i\sum\limits_{i|j}-\dfrac{i}{j}x^{j})=\exp(\sum\limits_{i=1}^{+\infty}a_i\sum\limits_{j=1}^{+\infty}\dfrac{1}{j}x^{ij})</script><p>而复合的计算比较复杂，然而通常可以使用拉格朗日反演之类的方法搞。</p>
<hr>
<p>对于带标号的组合类（下面的 GF 默认为 EGF），前三种操作是一样的，需要讨论的只是集合。</p>
<p>由于是带标号，所以没有“不可重集”这种说法，我们要解决的只是<strong>物品带标号的对象的无标号组合</strong>。</p>
<p>枚举对象的数量 $i$，由于组合无标号所以要去掉 $i!$，因此答案是：</p>
<script type="math/tex; mode=display">
\sum\limits_{i=0}^{+\infty} \dfrac{A^i(x)}{i!}=\exp(A(x))</script><p>上面所说的未免都有些抽象，接下来举几个相对具体的例子。</p>
<hr>
<blockquote>
<p>例题 $22$：[Luogu P4389] 付公主的背包</p>
<p>有 $n$ 个物品，第 $i$ 个大小为 $v_i$，有无限件，对每个 $i\in [1,m]$，求选择一些物品大小和为 $i$ 的方案数，不区分放入物品顺序。</p>
</blockquote>
<p>大小和为 $i$，没有规定每一份“大小”的编号，所以对象内本身是无标号的。</p>
<p>不区分物品放入顺序，所以组合也是无标号的。</p>
<p>所以使用 OGF 的欧拉变换即可，时间复杂度 $O((n+m)\log m)$。</p>
<hr>
<blockquote>
<p>例题 $23$：[Luogu P5748] 集合划分计数</p>
<p>求出 $\text{Bell}(n)$，表示将集合 $\{1,2,\ldots,n\}$ 划分为若干个无标号非空子集的方案数。</p>
</blockquote>
<p>集合是 $\{1,2,\ldots,n\}$ 本身有标号，所以是 EGF。</p>
<p>划分成无标号子集，所以组合是无标号的。</p>
<p>所以使用 EGF 做 $\exp$，我们只需要求出非空子集的 EGF，而这里 $\{1,\ldots,i\}$ 就这一种集合，所以是 $\sum\limits_{i=1}^{+\infty}\dfrac{x^i}{i!}=\exp(x)-1$，所以答案：</p>
<script type="math/tex; mode=display">
\exp(\exp(x)-1)</script><p>这就是 Bell 数的 EGF。</p>
<p>时间复杂度为 $O(n\log n)$。</p>
<hr>
<blockquote>
<p>例题 $24$：[CF 438 E] The Child and Binary Tree</p>
<p>求有多少点带权二叉树，点权在给定集合 $S$ 中（$|S|=n$），且所有点的点权和为 $m$，二叉树点无标号，但区分左右儿子。</p>
</blockquote>
<p>定义二叉树的大小为其点权和，设二叉树的 OGF 为 $F(x)$，再设给定集合 $S$ 的 OGF 为 $G(x)$。</p>
<p>考虑根结点，可以分成左右儿子递归，它们的 OGF 也都是 $F(x)$，加上根结点的点权就有：</p>
<script type="math/tex; mode=display">
F(x)=G(x)F^2(x)+1</script><p>最后的 $+1$ 是递归边界：没有根结点的空树。</p>
<p>这是一个关于 $F(x)$ 的二次方程，解之：</p>
<script type="math/tex; mode=display">
F(x)=\dfrac{1\pm\sqrt{1-4G(x)}}{2G(x)}</script><p>出现两解，我们带入常数项检验，即求 $F(0)$，可以用洛必达求出（或者上下看看直接毛估估），只有取减号才满足我们的要求。</p>
<p>但是 $2G(x)$ 常数项为 $0$ 不方便求逆，我们可以直接上下同除掉最低次项，也可以分子有理化：</p>
<script type="math/tex; mode=display">
F(x)=\dfrac{2G(x)}{1+\sqrt{1-4G(x)}}</script><p>时间复杂度为 $O(n\log n)$。</p>
<hr>
<blockquote>
<p>例题 $25$：十二重计数法 X</p>
<p>求将 $n$ 划分成 $m$ 个无序自然数之和的方案数。</p>
</blockquote>
<p>将问题转换一下，设 $t_x$ 表示划分出的不小于 $x$ 的数的数量，由于 $n=\sum\limits_{i=1}^{+\infty}[n\ge i]$，所以有 $n=\sum t_x$，而 $t_x$ 可以有任意多个，只要每个 $t_x$ 都在 $[1,m]$ 中（有 $0$ 可以直接拿走）。</p>
<p>因此问题变成了将 $n$ 拆分成若干个不超过 $m$ 的正整数之和，这就是欧拉变换：</p>
<script type="math/tex; mode=display">
[x^n]\prod\limits_{i=1}^m\dfrac{1}{1-x^i}</script><p>时间复杂度为 $O((n+m)\log n)$。</p>
<hr>
<h3 id="简单的图计数"><a href="#简单的图计数" class="headerlink" title="简单的图计数"></a>简单的图计数</h3><p>这里用生成函数解决一些比较简单的图计数问题，所有图默认为简单图。</p>
<p>树的计数可能需要用到 Prufer 序列等东西，以后再说。</p>
<ol>
<li>无向图：$n$ 个点的带标号无向图数量为 $2^{\frac{n(n-1)}{2}}$；</li>
<li>有向图：$n$ 个点的带标号有向图数量为 $2^{n(n-1)}$；</li>
<li>竞赛图：$n$ 个点的带标号竞赛图数量为 $2^{\frac{n(n-1)}{2}}$。</li>
</ol>
<hr>
<blockquote>
<p>例题 $26$：</p>
<p>求 $n$ 个结点的连通无向图数量，点带标号。</p>
</blockquote>
<p>无向图可以看作连通无向图的带标号组合，设无向图的 EGF 为 $F(x)$，连通图的 EGF 为 $G(x)$，那么 $F(x)=\exp(G(x))$，所以 $G(x)=\ln(F(x))$。</p>
<p>时间复杂度为 $O(n\log n)$。</p>
<hr>
<blockquote>
<p>例题 $27$：</p>
<p>求 $n$ 个结点的强连通竞赛图数量，点带标号。</p>
</blockquote>
<p>竞赛图可以看作强连通分量的序列，设竞赛图的 EGF 为 $F(x)$，强连通竞赛图的 EGF 为 $G(x)$，那么 $F(x)=\dfrac{1}{1-G(x)}$，所以 $G(x)=\dfrac{F(x)-1}{F(x)}$，注意 $[x^0]F(x)=1$。</p>
<p>时间复杂度为 $O(n\log n)$。</p>
<hr>
<blockquote>
<p>例题 $28$：</p>
<p>求 $n$ 个结点的二分图数量，点带标号。</p>
</blockquote>
<p>设 $F(x),G(x)$ 分别为连通二分图和二分图数量的 EGF，$F_0(x),G_0(x)$ 分别是连通二分图和二分图给每个结点二染色使得相邻结点不同色的 EGF。</p>
<p>那么我们有：</p>
<script type="math/tex; mode=display">
G(x)=\exp(F(x)) \\
G_0(x)=\exp(F_0(x)) \\
F_0(x)=2F(x)</script><p>最后一行是因为连通的二分图恰有交换两部颜色的两种二染色。</p>
<p>所以 $G(x)=\sqrt {G_0(x)}$，而 $\displaystyle [x^n]G_0(x)=\sum\limits_{i=0}^{n}\binom n i 2^{i(n-i)}$ 可以通过 FFT 算出。</p>
<p>注意这里一件有趣的事情：在计算 $G_0(x)$ 时由于 $\displaystyle i(n-i)=\binom n 2-\binom i 2-\binom {n-i}{2}$，所以我们实际上在用形如：</p>
<script type="math/tex; mode=display">
F(x)=\sum\limits_{i=0}^{+\infty}\dfrac{f_i}{i!\times 2^{\binom i 2}}x^i</script><p>的生成函数做卷积，我不知道这东西有没有正式的名字，就姑且叫它<strong>“组合型生成函数”</strong>吧。</p>
<p>时间复杂度为 $O(n\log n)$。</p>
<hr>
<blockquote>
<p>例题 $29$：</p>
<p>求 $n$ 个结点的有向无环图数量，点带标号。</p>
</blockquote>
<p>DAG 中剥掉所有没有入度的点仍得 DAG，这启发我们找出没有入度的点。</p>
<p>令 $f_n$ 表示答案，钦定 $x$ 个没有入度的点，这些点到其余点随便连边，然后容斥可以得到：</p>
<script type="math/tex; mode=display">
f_n=\sum\limits_{i=1}^n (-1)^{i+1}\times \binom n i \times f_{n-i}\times 2^{i(n-i)}</script><p>根据这个式子我们转化成生成函数，设两个前面所说的“组合型生成函数”：</p>
<script type="math/tex; mode=display">
F(x)=\sum\limits_{i=0}^{+\infty}\dfrac{f_i}{i!\times 2^{\binom i 2}}x^i \\ 
G(x)=\sum\limits_{i=0}^{+\infty}\dfrac{(-1)^{i+1}}{i!\times 2^{\binom i 2}}x^i \\</script><p>所以有：</p>
<script type="math/tex; mode=display">
F(x)=F(x)G(x)+1 \\
F(x)=\dfrac{1}{1-G(x)}</script><p>时间复杂度为 $O(n\log n)$。</p>
<hr>
<blockquote>
<p>例题 $30$：</p>
<p>求 $n$ 个结点的强连通有向图数量，点带标号。</p>
</blockquote>
<p>设有向图的数量为 $f_n=2^{n(n-1)}$，强连通图的数量为 $g_n$，我们需要 $f,g$ 两个序列之间的关系。</p>
<p>但直接建立是困难的，我们考虑按照上题的方法，将有向图看作强连通分量构成的 DAG，然后同样容斥：</p>
<script type="math/tex; mode=display">
f_n=\sum\limits_{i=1}^n h_i\times \binom n i\times f_{n-i}\times 2^{i(n-i)}</script><p>考虑这里的容斥系数 $h_n$ 的实际含义：将 $n$ 个点的图分成若干个强连通分量，如果奇数个则容斥系数为 $1$，偶数个则容斥系数为 $-1$。</p>
<p>考虑 $f,h$ 对应的“组合型生成函数” $F(x),H(x)$，我们可以知道：</p>
<script type="math/tex; mode=display">
F(x)=F(x)H(x)+1 \\
H(x)=\dfrac{F(x)-1}{F(x)}</script><p>接下来我们建立 $h,g$ 之间的关系，枚举 $1$ 所在的强连通分量：</p>
<script type="math/tex; mode=display">
h_n=g_n-\sum\limits_{i=1}^{n-1} \binom{n-1}{i-1} g_ih_{n-i} \\
g_n=h_n+\sum\limits_{i=1}^{n-1}\dfrac{(n-1)!}{(i-1)!(n-i)!}g_ih_{n-i} \\
\dfrac{g_n}{(n-1)!}=\dfrac{h_n}{(n-1)!}+\sum\limits_{i=1}^{n-1}\dfrac{g_i}{i!}\times \dfrac{h_{n-i}}{(n-i)!}</script><p>于是设：</p>
<script type="math/tex; mode=display">
G(x)=\sum\limits_{i=1}^{+\infty}\dfrac{g_i}{(i-1)!}x^i \\
H_0(x)=\sum\limits_{i=1}^{+\infty}\dfrac{h_i}{(i-1)!}x^i \\
H_1(x)=\sum\limits_{i=1}^{+\infty}\dfrac{h_i}{i!}x^i</script><p>那么有：</p>
<script type="math/tex; mode=display">
G(x)=H_0(x)+G(x)H_1(x) \\
G(x)=\dfrac{H_0(x)}{1-H_1(x)}</script><p>时间复杂度为 $O(n\log n)$。</p>
<hr>
<h2 id="5-Burnside-引理"><a href="#5-Burnside-引理" class="headerlink" title="5. Burnside 引理"></a>5. Burnside 引理</h2><p>参考：<a target="_blank" rel="noopener" href="https://www.luogu.com.cn/blog/Soulist/solution-p4980">https://www.luogu.com.cn/blog/Soulist/solution-p4980</a></p>
<p>提示：作者不会群论，证明可能是不严谨的，也不保证内容和记号恰当，如有错误烦请指出。</p>
<p>由于发现大纲里有 Burnside 和 Pólya 所以来紧急营业。</p>
<hr>
<h3 id="群和子群"><a href="#群和子群" class="headerlink" title="群和子群"></a>群和子群</h3><p>考虑一个集合 $G$ 以及定义在 $G$ 上的二元运算 $\times$，如果满足下述条件，则称 $(G,\times)$ 是一个<strong>群</strong>：</p>
<ul>
<li>封闭性：$a,b\in G$，则 $a\times b\in G$；</li>
<li>结合律：$a,b,c\in G$，则 $(a\times b)\times c=a\times (b\times c)$；</li>
<li>存在单位元：$\exists e\in G$，$\forall a\in G, a\times e=e\times a=a$；</li>
<li>每个元素可逆：$\forall a\in G$，$\exists b\in G, a\times b=b\times a=e$，称 $b=a^{-1}$。</li>
</ul>
<p>例如，$(R\backslash\{0\},\times )$ 以及函数与其复合运算构成群。</p>
<p>当不要求存在单位元和逆元时，$(G,\times)$ 称为<strong>半群</strong>，例如 $(R,\max)$ 是半群。</p>
<p>当不要求存在逆元时，$(G,\times)$ 称为<strong>幺半群</strong>，例如 $(R,\times)$ 是幺半群。</p>
<p>当满足交换律 $a\times b=b\times a$ 时称 $(G,\times)$ 为<strong>交换群</strong>或<strong>阿贝尔群</strong>，例如 $(R,+)$ 是交换群。</p>
<p>一个群的单位元和每个元素的逆元都是唯一的。</p>
<hr>
<p>考虑群 $(G,\times)$，如果集合 $H\subseteq G$ 且 $(H,\times)$ 是群，那么称 $(H,\times)$ 是 $(G,\times)$ 的<strong>子群</strong>。</p>
<p>可以证明，如果 $a\in H$，那么 $a^{-1}\in H$，并且单位元 $e\in H$。</p>
<p>对于子群 $(H,\times)$，令 $gH=\{g\times h|h\in H\}$ 为 $H$ 关于 $g$ 的左陪集，类似地定义右陪集 $Hg=\{h\times g|h\in H\}$，其中 $g\in G$。</p>
<p>下面说明一条关于陪集的重要性质（都以右陪集为例）：</p>
<ul>
<li>若 $Hg_1\cap Hg_2\ne \varnothing$，则 $Hg_1=Hg_2$。</li>
</ul>
<p>假设 $g\in Hg_1\cap Hg_2$，那么设 $g=h_1\times g_1=h_2\times g_2$，考虑一个 $g’=h_3\times g_1\in Hg_1$，则 $g’=h_3\times (h_1^{-1}\times h_1)\times g_1=(h_3\times h_1^{-1})\times g=(h_3\times h_1^{-1}\times h_2)\times g_2\in Hg_2$，同理可以证明 $Hg_2\subseteq Hg_1$，因此我们得到了 $Hg_1=Hg_2$。</p>
<p>同时我们需要一则比较容易的性质：</p>
<ul>
<li>$|H|=|Hg|$，这是因为假设存在 $h_1\times g=h_2\times g$，那么两边乘 $g^{-1}$ 得到了 $h_1=h_2$。</li>
</ul>
<p>根据上面的两条性质，我们可以知道一个子群关于 $G$ 所有元素的陪集的结构：</p>
<p><strong>$H$ 关于 $G$ 中元素的陪集共有 $\dfrac{|G|}{|H|}$ 种，两两不交且大小均为 $|H|$。</strong></p>
<p>将这个陪集的种类数记为 $[G:H]$，根据上面的推导有 $|H|\times [G:H]=|G|$。</p>
<hr>
<h3 id="轨道-稳定子定理和-Burnside-引理"><a href="#轨道-稳定子定理和-Burnside-引理" class="headerlink" title="轨道-稳定子定理和 Burnside 引理"></a>轨道-稳定子定理和 Burnside 引理</h3><p>把由作用于集合 $F$ 上的变换构成的群称作变换群，例如实变函数与其复合运算构成的群就是作用在 $R$ 上的变换群。</p>
<p>也就是说，对于群 $(G,\times)$，任取 $g\in G$，都是形如 $g:F\to F$。</p>
<p><strong>轨道：对于一个 $f\in F$，定义其在 $G$ 作用下的轨道为所有 $g(f) (g\in G)$ 的集合，记为 $G(f)$。</strong></p>
<p><strong>稳定子：对于一个 $f\in F$，定义其在 $G$ 作用下的稳定子是所有满足 $g(f)=f$ 的 $g$ 构成的集合 $G^f$。</strong></p>
<p>那么我们有如下定理：</p>
<p><strong>轨道-稳定子定理：$|G(f)|\times |G^f|=|G|$。 </strong></p>
<p>这个定理的证明依赖于上面写的陪集的性质：</p>
<p>首先是一个简单的命题：$(G^f,\times)$ 是 $G$ 的一个子群，因为如果 $g_1(f)=g_2(f)=f$，那么 $(g_1\times g_2)(f)=f$，并且 $g_1^{-1}(f)=f$。</p>
<p>所以实际上我们只需要证明：$[G:G^f]=G(f)$。</p>
<p>可以这么理解：所有 $g(f)$ 相同的 $g$ 构成了若干个等价类，每个等价类中作用于 $G^f$ 的陪集都相等，所以等价类数等于 $[G:G^f]$。</p>
<hr>
<p>若对于两个元素 $f_1,f_2\in F$，使得存在 $g\in G$ 使得 $g(f_1)=f_2$，则称 $f_1,f_2$ 在 $G$ 作用意义下等价，设 $|F/G|$ 为这个等价类的个数。</p>
<p><strong>Burnside 引理给出了计算 $|F/G|$ 的一个方法：</strong></p>
<script type="math/tex; mode=display">
|F/G|=\dfrac{1}{|G|}\sum\limits_{g\in G}|F^g|</script><p>其中 $|F^g|$ 是满足 $g(f)=f$ 的不动点 $f$ 的个数。</p>
<p>证明：</p>
<p>考虑如何描述 $|F/G|$，由于每个轨道上的 $f$ 互相等价，所以只要求出轨道数量，而一个大小为 $S$ 的轨道可以由每个元素贡献一个 $\dfrac{1}{S}$，因此就有：</p>
<script type="math/tex; mode=display">
|F/G|=\sum\limits_{f\in F}\dfrac{1}{|G(f)|}</script><p>再套用轨道-稳定子定理：</p>
<script type="math/tex; mode=display">
|F/G|=\sum\limits_{f\in F}\dfrac{1}{|G(f)|}=\sum\limits_{f\in F}\dfrac{|G^f|}{|G|}=\dfrac{1}{|G|}\sum\limits_{g\in G}|F^g|</script><p>于是 Burnside 引理得证。</p>
<hr>
<h3 id="置换群和-Polya-定理"><a href="#置换群和-Polya-定理" class="headerlink" title="置换群和 Pólya 定理"></a>置换群和 Pólya 定理</h3><p>最常见的变换群之一就是置换群，作用于 $n$ 元集上的置换群可以看作若干个 $1,\ldots,n$ 的排列构成的群，运算为排列的复合，将排列 $a_1,\ldots,a_n$ 作用于元素 $f$ 就相当于将 $f$ 中的第 $i$ 个元素转移到 $a_i$ 处。</p>
<p>考虑如下问题：</p>
<p><strong>给定 $n$ 元置换群 $G$ 和一个整数 $m$，令 $F$ 是将 $1,\ldots,n$ 中每个元素染上 $m$ 种颜色之一的所有 $m^n$ 种方案构成的集合，求 $|F/G|$。</strong></p>
<p>可以直接套用 Burnside 引理，我们要求的就是 $|F^g|$。</p>
<p>而如果 $f$ 是 $g$ 作用下的一个不动点，那么对于置换 $g$ 中每个循环圈，$f$ 中这些位置的颜色必须都相等，所以我们相当于只能给每个循环圈一个颜色，所以 $|F^g|=m^{\operatorname{cyc}(g)}$，其中 $\operatorname{cyc}(g)$ 为置换 $g$ 的循环圈个数，带入 Burnside 引理得到：</p>
<script type="math/tex; mode=display">
|F/G|=\dfrac{1}{|G|}\sum\limits_{g\in G}m^{\operatorname{cyc}(g)}</script><p>这就是 Pólya 定理。</p>
<hr>
<blockquote>
<p>例题 $31$：[Luogu P4980] Pólya 定理</p>
<p>求给 $n$ 元环每个点染 $n$ 种颜色中一种的本质不同方案数，能旋转互相得到的算作等价。</p>
</blockquote>
<p>本题中置换群为 $G=\{[1,2,\ldots,n],[2,3,\ldots,n,1],\ldots,[n,1,\ldots,n-1]\}$，而 $\operatorname{cyc}([i,i+1,\ldots,n,1,\ldots,i-1])=\gcd(i-1,n)$，因此运用 Pólya 定理知答案为：</p>
<script type="math/tex; mode=display">
\dfrac{1}{n}\sum\limits_{i=0}^{n-1}n^{\gcd(i,n)}=\dfrac{1}{n}(\sum\limits_{d|n}n^d\varphi(\dfrac{n}{d}))</script><p>分解素因数后搜索即可。</p>
<p>时间复杂度为 $O(\sqrt n)$。</p>
<hr>
<blockquote>
<p>例题 $32$：[HNOI 2009] 图的同构计数</p>
<p>求 $n$ 个点的本质不同无向图数量，同构的视作本质相同。</p>
</blockquote>
<p>将边是否存在看作黑白两种颜色，此题中置换群 $G$ 包含所有 $n$ 元置换。</p>
<p>运用 Burnside 引理枚举 $g\in G$，设 $g$ 的所有循环圈大小依次为 $p_1,\ldots,p_m$，考虑跨越长度为 $p_i,p_j$ 两个循环圈中各一个点 $x,y$ 的边，设 $g=[g_1,\ldots,g_n]$，那么对于任意的 $g^z_x$ 和 $g^z_y$，它们之间边的颜色和 $x,y$ 相同，而容易知道两个循环圈上分别跑循环时的循环节长度是 $\operatorname{lcm}(p_i,p_j)$，所以循环圈个数 $\dfrac{p_ip_j}{\operatorname{lcm}(p_i,p_j)}=\gcd(p_i,p_j)$。</p>
<p>但是 $i=j$ 的情况有些特殊，环上所有跨度相等的边颜色都要相同，实际上是 $\lfloor\dfrac{p_i}{2}\rfloor$ 个等价类。</p>
<p>故对于确定的 $g$，其指数为：</p>
<script type="math/tex; mode=display">
\sum\limits_{i=1}^m\lfloor\dfrac{p_i}{2}\rfloor+\sum\limits_{i=1}^m\sum\limits_{j=1}^{i-1}\gcd(p_i,p_j)</script><p>在求得 $p_1,\ldots,p_m$ 后容易在 $O(\operatorname{poly}(n))$ 内求出。</p>
<p>而我们实际不必枚举所有排列，而只需枚举 $p_1,\ldots,p_m$ 的可重集，可以通过多项式系数乘圆排列并去重得到方案数。</p>
<p>所以枚举量实际是 $n$ 的正整数划分数 $p(n)$。</p>
<p>时间复杂度为 $O(p(n)\times n^2)$ 或更低。</p>
<hr>
<blockquote>
<p>例题 $33$：[MtOI 2018] 魔力环</p>
<p>给长度为 $n$ 的环二染色，使得不存在连续 $k+1$ 个黑点，求本质不同方案数，旋转等价。</p>
</blockquote>
<p>类似例题 $31$，考虑直接使用 Burnside 定理，可以转化为：第 $i$ 个点和第 $i+d$ 个点颜色相同，并且没有连续 $k+1$ 个黑点的方案数。</p>
<p>那么整个环可以看作 $\dfrac{n}{d}$ 个小链粘合，可以发现不存在连续 $k+1$ 个黑点当且仅当<strong>小链不全为黑并且小链看作环时不存在连续 $k+1$ 个黑点。</strong></p>
<p>前者是平凡的，我们计数后者，设 $f(d)$ 为长度为 $d$ 的环不包含连续 $k+1$ 个黑点的方案数，注意这里没有旋转等价的限制。</p>
<p>首先破环为链，首尾加起来不能超过 $k$ 个黑点，对此的特殊处理可以通过枚举首尾之和 $s$，再考虑中间，假设总共 $A$ 个白点（由于两边已经放好，所以此时一定有两个白点在两边，而 $A=1$ 也是平凡的）和 $B$ 个黑点，我们可以看成将 $B$ 个黑点插入 $A-1$ 个段并且每一段不大于 $k$ 的方案数，这是一个简单容斥，枚举有几个段爆了：</p>
<script type="math/tex; mode=display">
\sum\limits_{i=0}^{A}(-1)^i\times \binom {A-1}{i}\times \binom {B-i\times (k+1)+A-2}{A-2}</script><p>这里的时间复杂度实际上是 $O(\min(A,\dfrac{B}{k}))$，再加上前面枚举的前后之和 $\in[0,k]$，总共是 $O(B)$ 的，这里的 $B$ 是总黑点数，它等于 $\dfrac{m}{d}$。</p>
<p>由于 $d$ 必须同时是 $n,m$ 的因数，设 $d_0=\gcd(n,m)$，最后复杂度实际上是 $\sigma_1(d_0)$，它是 $O(d_0\log d_0)$ 的。</p>
<p>时间复杂度为 $O((n+m)\log (n+m))$。</p>
<hr>
<h2 id="6-几个特殊数列"><a href="#6-几个特殊数列" class="headerlink" title="6. 几个特殊数列"></a>6. 几个特殊数列</h2><p>本段将介绍几个在计数问题中十分有用的<strong>数列或数阵</strong>以及它们的相关性质。</p>
<p>由于本篇文章以后会继续扩展（包括多项式部分以及其他一些组合工具），所以这里所写的主要服务于 NOI 大纲，较为简单。</p>
<hr>
<h3 id="卡特兰数"><a href="#卡特兰数" class="headerlink" title="卡特兰数"></a>卡特兰数</h3><p>考虑如下问题：求包含 $n$ 个 $0$ 和 $n$ 个 $1$ 的序列个数，使得每个前缀中 $1$ 的个数不少于 $0$ 的个数。</p>
<p>这个问题可以描述成格路计数问题：从 $(0,0)$ 走到 $(2\times n,0)$，每一步可以由向量 $(1,1)$ 或 $(1,-1)$ 行进，求路径不经过 $y=0$ 下方区域的方案数。</p>
<p>将答案的个数记作卡特兰数 $Cat_n$，它的前几项是：$[1,2,5,14,42,\ldots]$。</p>
<p>我们这里介绍三种求其表达式的方法：</p>
<hr>
<p><strong>翻折法：</strong></p>
<p>有点类似于中考经典题。</p>
<p>由组合数，总方案数为 $\displaystyle\binom {2n}{n}$，我们只需求出不满足的方案。</p>
<p>而不满足的情况一定是经过了直线 $y=-1$，下面我们给出一个更加广泛的命题：</p>
<p>从 $S(0,a)$ 走到 $T(n,b)$ 的，每次往右下或右上走，且触碰过直线 $y=c$ 的路径数量，等于从 $S’(0,2\times c-a)$ 走到 $T(n,b)$ 的同样要求的路径数（注意要求 $(c-a)(c-b)\ge 0$）。</p>
<p>取最早的与 $y=c$ 的交点，将之前的部分沿 $x=c$ 翻折，就得到了一一对应。</p>
<p><img src="https://cdn.luogu.com.cn/upload/image_hosting/i7xnbc6g.png" alt=""></p>
<p>同样也可以翻折 $T$，结果都是将同侧转化为异侧的简单情况。</p>
<p>所以在求卡特兰数过程中经过 $y=-1$ 的路径数量就等于从 $(0,-2)$ 走到 $(2\times n,0)$ 的方案数，可以发现总共走了 $n+1$ 步左上和 $n-1$ 步左下，所以方案数是 $\displaystyle\binom {2n}{n-1}$。</p>
<p>所以卡特兰数为 $\displaystyle Cat_n=\binom {2n}{n}-\binom {2n}{n-1}$。</p>
<hr>
<p><strong>Raney 引理法：</strong></p>
<p>我们首先要介绍如下定理：</p>
<p><strong>Raney 引理：设有整数序列 $a_1,\ldots,a_n$ 满足 $\sum\limits_{i=1}^n a_i=1$，则它恰有一种循环同构序列满足所有非空前缀和均为正。</strong></p>
<p>也考虑转化为格路问题，从 $(0,0)$ 走到 $(n,1)$，每一步沿着向量 $(1,a_i)$ 走一步。</p>
<p>从起点到终点拉一条线 $l:y=\dfrac{x}{n}$，不难发现前缀和均为正等价于折线完全位于该直线及更上方。</p>
<p>先随便找一个循环位移，再找一个位于 $l$ 下方且离 $l$ 距离最远的点 $A$，这个点以前部分路径称为 $P_1$，以后部分称为 $P_2$，那么 $P_2P_1$ 一定是合法的。</p>
<p>证明：我们直接把整条路径在 $(n,1)$ 后再复制一遍（一条从 $(n,1)$ 到 $(2\times n,2)$ 的路径），$A$ 点在复制后的位置为 $A’$，那么由于 $A$ 是离 $l$ 最远的点，所以 $AA’$ 必然是所有平行于 $l$ 的直线中最低的，所以从 $A$ 到 $A’$ 这一段路径满足题目要求。</p>
<p>如下图，最下方紫线为 $AA’$，可以发现其他紫线都在其上方（图片里的一些距离长短和位置是不准的，只是直观理解一下）：</p>
<p><img src="https://cdn.luogu.com.cn/upload/image_hosting/jqs3oyj8.png" alt=""></p>
<p>那么这个 $A$ 是否唯一呢？由于 $l$ 的斜率是 $\dfrac{1}{n}$，所以如果有两个整点离它同样远，那么横坐标差为 $n$ 的倍数，而在它下方的点横坐标在 $[2,n-1]$ 中，所以不可能有两个，$A$ 是唯一的。</p>
<p>那如果 $A$ 不存在呢？那么我们画出的就是唯一满足条件的折线了，实际上我们也可以将 $(0,0)$ 看作这个 $A$，而 $(n,1)$ 就是那个 $A’$，这是更严谨的说明。</p>
<p><strong>由此我们证明了存在唯一的 $A$ 使得从它开始的循环同构序列所有非空前缀和为正，引理得证。</strong></p>
<p>Raney 引理中提到的结构还有一个特殊结果：满足和为 $1$ 的整数序列的所有循环同构各不相同。</p>
<p>证明：假设有两个循环同构相同，我们可以导出序列有整周期，设周期完整出现 $d$ 次，一个周期中的和为 $s_0$，有 $ds_0=s$，所以 $d=1$，说明没有非平凡周期，也就是其实所有循环同构不同。</p>
<p>事实上，运用与 raney 引理类似的方法，我们可以<strong>得到 $n\perp m$ 时的 $(n,m)-\text{dyck}$ 路计数公式</strong>。</p>
<p>那么如何用该引理得到卡特兰数通项公式呢？</p>
<p>我们考虑<strong>包含 $n+1$ 个 $1$ 和 $n$ 个 $-1$ 的数列</strong>，它的总和是 $1$，对其运用 raney 引理得到其 $2n+1$ 个循环同构中恰有一个非空前缀和全正，所以满足 raney 引理条件的序列共有 $\dfrac{\binom {2n+1}{n}}{2n+1}$ 个。</p>
<p>由于前缀和都是正数，所以第一个数必然是 $1$ 而不是 $-1$，那么我们删除第一个数，就得到了一个<strong>包含 $n$ 个 $1$ 和 $n$ 个 $-1$ 的数列，每个前缀和非负</strong>，容易发现这就是卡特兰数的要求，所以：</p>
<script type="math/tex; mode=display">
Cat_n=\dfrac{\binom {2n+1}{n}}{2n+1}=\dfrac{(2n)!}{n!(n+1)!}=\dfrac{\binom {2n}{n}}{n+1}=\binom {2n}{n}-\binom{2n}{n-1}</script><p>得到了同样的结果。</p>
<hr>
<p><strong>生成函数法：</strong></p>
<p>首先我们需要一个卡特兰数的递推公式：</p>
<script type="math/tex; mode=display">
Cat_n=\sum\limits_{i=1}^{n}Cat_{i-1}Cat_{n-i}</script><p>其中 $Cat_0=1$。</p>
<p>这是因为，在折线模型中考察折线与 $y=0$ 的最左交点 $(2i,0)$，那么这之后的方案自然是 $Cat_{n-i}$，而由于我们钦定这是最左，所以这之前不能碰到 $y=0$，所以我们必须是 $(0,0)\to (1,1)\to (2i-1,1)\to (2i,0)$，而中间从 $(1,1)$ 到 $(2i-1,1)$ 也是一个卡特兰数的走法 $Cat_{i-1}$。</p>
<p>设卡特兰数的一般型生成函数为 $C(x)$，那么有：</p>
<script type="math/tex; mode=display">
C(x)=xC^2(x)+1</script><p>这是一个二次方程，求解得到：</p>
<script type="math/tex; mode=display">
C(x)=\dfrac{1\pm \sqrt{1-4x}}{2x}</script><p>类似二叉树那题，可以用洛必达法则带入常数项检验，发现应该取减号。</p>
<p>接下来一步是展开 $\sqrt{1-4x}$，这需要借助我们之前所说的广义二项式定理：</p>
<script type="math/tex; mode=display">
(1-4x)^{0.5}=\sum\limits_{i=0}^{+\infty}\dfrac{(0.5)^{\underline{i}}}{i!}(-4x)^{i}</script><p>而 $(0.5)^{\underline{i}}$ 在乘上 $2^i$ 后是个类似双阶乘的东西，我们尝试把它搞出来：</p>
<script type="math/tex; mode=display">
(1-4x)^{0.5}=1+\sum\limits_{i=1}^{+\infty}\dfrac{(-2)^i(-1)^{i+1}(2i-3)!!}{i!}x^i</script><p>这里我们假设 $(-1)!!=1$，接下来我们把这堆东西带进 $C(x)$ 的表达式中：</p>
<script type="math/tex; mode=display">
C(x)=\dfrac{\sum\limits_{i=1}^{+\infty} \dfrac{2^i\times (2i-3)!!}{i!}x^i}{2x}=\sum\limits_{i=0}^{+\infty}\dfrac{2^i(2i-1)!!}{(i+1)!}x^{i}</script><p>那么我们其实已经有了 $Cat_n$ 的表达式，下面就是要把它化简一下变得好看一些：</p>
<script type="math/tex; mode=display">
Cat_n=\dfrac{2^n\times (2n-1)\times (2n-3)\times \ldots\times 3\times 1}{(n+1)!}=\dfrac{2^n\times \dfrac{(2n)!}{2^n\times n!}}{(n+1)!}=\dfrac{(2n)!}{n!(n+1)!}</script><p>这和我们之前方法得到的结果一样，也是 $\displaystyle\binom {2n}{n}-\binom{2n}{n-1}$。</p>
<hr>
<p>接下来介绍的是卡特兰数在组合数学中一些比较典型的出现：</p>
<ul>
<li><p>$n$ 个数依次排好，有一个初始为空的栈，每次选择弹出栈顶（如果栈非空）或者将当前最靠前的数入栈，最终得到的出栈序列数为 $Cat_n$。</p>
<p>维护一个描述序列，进栈时记录 $1$，出栈时记录 $0$，每个前缀 $1$ 不能少于 $0$，所以与卡特兰数对应。</p>
</li>
<li><p>顶点标号的凸 $n$ 边形的三角剖分数量为 $Cat_{n-2}$。</p>
<p>考虑写出递推式，平移一下下标就可以得到卡特兰数。</p>
</li>
<li><p>$n$ 对括号的匹配括号串数量为 $Cat_n$。</p>
<p>根据定义显然。</p>
</li>
<li><p>$n$ 个点的无标号有根二叉树个数为 $Cat_n$，左右儿子区分。</p>
<p>根据递推式或生成函数得证。</p>
</li>
<li><p>$n$ 个点的无标号有根树个数为 $Cat_{n-1}$，儿子区分。</p>
<p>考虑删除根结点后的括号序即可。</p>
</li>
</ul>
<p>由此可见卡特兰数在推导一些<strong>无标号递归结构</strong>时的作用。</p>
<hr>
<blockquote>
<p>例题 $34$：[SCOI 2010] 生成字符串</p>
<p>求 $n$ 个 $1$ 和 $m$ 个 $0$ 组成的序列中有多少满足任意前缀中 $1$ 的个数不少于 $0$ 的个数。</p>
</blockquote>
<p>将卡特兰数稍微扩展了一下，仍然可以使用翻折法解决问题。</p>
<ul>
<li><p>当 $n&lt;m$ 时，显然答案为 $0$；</p>
</li>
<li><p>当 $n\ge m$ 时，将问题转化为格路计数：从 $(0,0)$ 走到 $(n+m,n-m)$，只能向右上或右下走，且不经过 $y=-1$ 的方案数。</p>
<p>所有方案是 $\displaystyle\binom {n+m}{m}$，而经过 $y=-1$ 的方案数相当于将 $(0,0)$ 翻到 $(0,-2)$，走到 $(n+m,n-m)$ 的方案数，这个过程需要向上 $n+1$ 次，向下 $m-1$ 次，也就是 $\displaystyle\binom {n+m}{m-1}$。</p>
<p>所以答案为 $\displaystyle\binom {n+m}{m}-\displaystyle\binom {n+m}{m-1}$。</p>
</li>
</ul>
<p>时间复杂度为 $O(n+m)$。</p>
<hr>
<blockquote>
<p>例题 $35$：</p>
<p>统计从 $(a,b)$ 走到 $(c,d)$，每一步向右上或右下，且<strong>依次</strong>经过直线 $y=a_1,y=a_2,\ldots,y=a_k$ 的方案数（也就是说存在一个路径上点的子序列依次在这些直线上）。</p>
</blockquote>
<p>感谢机房最强数学战力 uwagjaynoi 指导！</p>
<p>这是翻折法的一个扩展，我们可以对一个折叠起来的折线进行“展开”。</p>
<p>令 $a_0=b,a_{k+1}=d$，我们考虑将整个走的过程分成 $k$ 段，第 $i$ 段是从 $a_i$ 走到 $a_{i+1}$，其纵坐标改变了 $|a_{i+1}-a_i|$。</p>
<p>我们只需保证这个纵坐标变化量不变即可，对于 $a_i&gt;a_{i+1}$ 的情况我们把 $a_{i+1}$ 沿着 $a_i$ 翻折到 $2\times a_i-a_{i+1}$ 的位置，这样我们可以把折叠的部分不断展开，转化成 $a$ 递增的情形，然后直接求一个组合数就是答案了。</p>
<p>可以直接考虑总的纵坐标变化量，所以答案就是：</p>
<script type="math/tex; mode=display">
\binom{(c-a)+\sum\limits_{i=0}^k|a_i-a_{i+1}|}{c-a}</script><p>时间复杂度为 $O(c-a)$。</p>
<hr>
<blockquote>
<p>例题 $36$：THUSC 2021 题目来自民间</p>
<p>建立 $70$ 个点的无标号的区分儿子的有根树与不大于 $Cat_{69}$ 的正整数之间的双射。</p>
</blockquote>
<p>求删除根后的括号序列，本质上我们需要压缩括号序列。</p>
<p>直接根据字典序压缩，我们需要 DP 出给定一个前缀后还有多少种合法的括号序列，也可以根据翻折法直接计算（应该就是例题 $34$ 的结果）。</p>
<hr>
<h3 id="斐波那契数"><a href="#斐波那契数" class="headerlink" title="斐波那契数"></a>斐波那契数</h3><p>斐波那契数列是在 OI 中比较常用，也有较多性质的一个线性递推数列，其定义如下：</p>
<script type="math/tex; mode=display">
Fib_1=Fib_2=1 \\
Fib_i=Fib_{i-1}+Fib_{i-2}\ (i\ge 3)</script><p>它的前几项是 $[1,1,2,3,5,8,13,21,34,\ldots]$，有时我们也可以反向递推，例如 $Fib_0=0, Fib_{-1}=1$。</p>
<p>首先我们研究它的通项公式，它是二阶常系数齐次线性递推，我们有理由相信它有一个简洁的表达式。</p>
<p>考虑其生成函数 $F(x)$，由递推式可以知道 $F(x)$ 与 $xF(x)+x^2F(x)$ 大致相等，只是差了个一次项，需要补一个 $x$：</p>
<script type="math/tex; mode=display">
F(x)=xF(x)+x^2F(x)+x \\
F(x)=\dfrac{x}{1-x-x^2}=\dfrac{A}{1-\frac{1+\sqrt 5}{2}x}+\dfrac{B}{1-\frac{1-\sqrt 5}{2}x}</script><p>最后一步找出了 $x^2+x-1=0$ 的两个根，然后待定系数 $A,B$，我们解一解，具体过程省略，得到答案如下：</p>
<script type="math/tex; mode=display">
A=\dfrac{1}{\sqrt 5},\ B=-\dfrac{1}{\sqrt 5} \\
F(x)=\dfrac{1}{\sqrt 5}\Big(\sum\limits_{i=0}^{+\infty}(\dfrac{1+\sqrt 5}{2}x)^i-\sum\limits_{i=0}^{+\infty}(\dfrac{1-\sqrt 5}{2}x)^i\Big)</script><p>也就得到了斐波那契数列的通项公式：</p>
<script type="math/tex; mode=display">
Fib_i=\dfrac{1}{\sqrt 5}((\dfrac{1+\sqrt 5}{2})^i-(\dfrac{1-\sqrt 5}{2})^i)</script><hr>
<p>我们当然可以用矩阵快速幂等方法计算斐波那契数列第 $n$ 项，但作为一个线性递推数列，我们可以研究它在模意义下的周期。</p>
<p>斐波那契循环节证明非常复杂，这里暂时只给出部分结论：</p>
<p><strong>结论 $1$：斐波那契数列 $\bmod m$ 的周期不大于 $6\times m$。</strong></p>
<p><strong>结论 $2$：斐波那契数列 $\bmod 5$ 的最小正周期为 $20$。</strong></p>
<p><strong>结论 $3$：斐波那契数列 $\bmod p$（$p$ 是素数且 $p\equiv \pm 1\bmod 5$）的最小正周期是 $p-1$ 的因数。</strong></p>
<p><strong>结论 $4$：斐波那契数列 $\bmod p$（$p$ 是素数且 $p\equiv \pm 2\bmod 5$）的最小正周期是 $2p+2$ 的因数。</strong></p>
<p><strong>结论 $5$：设斐波那契数列 $\bmod p$（$p$ 是素数）的最小正周期为 $per$，则 $\bmod p^k$ 的最小正周期是 $p^{k-1}per$ 的因数。</strong> </p>
<p><strong>结论 $6$：设斐波那契数列 $\bmod p_i^{c_i}$（$p_i$ 是两两不同的素数）的最小正周期为 $per_i$，则 $\bmod \prod p_i^{c_i}$ 的最小正周期是 $\operatorname{lcm}(per_1,per_2,\ldots)$。</strong> </p>
<p>根据结论 $1$ 我们可以知道最小循环节的大致范围，根据结论 $2$ 到 $4$ 可以知道模素数的循环节，结合 $5,6$ 可以得到模任意数的一个循环节（在各步取因数过程中都直接取自身，就可以得到一个合法循环节）。</p>
<p>事实上对于一般的二阶常系数齐次线性递推数列，<strong>结论 $5,6$ 也是成立的</strong>，但 $2,3,4$ 需要涉及二次剩余和特征根。</p>
<hr>
<blockquote>
<p>例题 $37$：[NOI 2011] 兔农</p>
<p>设数列 $f_i$ 满足：</p>
<ul>
<li>$f_1=f_2=1$；</li>
<li>$f_i=f_{i-1}+f_{i-2}  (i&gt;2, f_{i-1}+f_{i-2}\not\equiv 1\bmod k)$</li>
<li>$f_i=f_{i-1}+f_{i-2}-1  (i&gt;2, f_{i-1}+f_{i-2}\equiv 1\bmod k)$</li>
</ul>
<p>求第 $n$ 项对 $p$ 取模的结果。</p>
</blockquote>
<p>这是一个变形的斐波那契数列，当出现 $\bmod k=1$ 的数就会减去 $1$。</p>
<p>考虑 $f_i\equiv a\bmod k$，根据斐波那契循环节的结论，我们知道所有斐波那契数列中 $\bmod k$ 可能的结果都在前 $6\times k$ 项中出现，我们暴力递推就可以找到第一个满足条件的数。</p>
<p>将 $f_i\bmod k$ 这个数列按 $0$ 分段，那么显然某一段的第一个数是上一段的倒数第二个数 $x$，并且这一段会变成 $0$ 则有 $xf_i\equiv 1\bmod k$ 即 $f_i\equiv x^{-1}\bmod k$（如果本身就是 $xf_i\equiv 0\bmod k$ 我们可以不管，因为和正常斐波那契数列递推一样）。</p>
<p>如果 $x$ 不存在逆元或不存在 $f_i\equiv x^{-1}$，那么数列接下来的部分全都是 $xf_i$，直接矩阵快速幂计算。</p>
<p>否则，找到第一个满足 $f_i\equiv x^{-1}$ 的 $i$，后一个就是 $0$。</p>
<p>于是我们会发现 $x$ 也是循环的，只要找到了 $x$ 的循环节就掌握了整个数列的循环节，而由于某个 $x$ 仅仅由上一个 $x$ 决定，所以循环节长度显然是 $O(k)$。</p>
<p>整个数列的循环节知道以后以循环为整体做矩阵快速幂即可。</p>
<p>所以我们在 $O(k\log k+\log n)$ 复杂度内解决这个问题。</p>
<hr>
<blockquote>
<p>例题 $38$：[WC 2021] 斐波那契</p>
<p>设数列 $F_i$ 满足：</p>
<ul>
<li>$F_0=a, F_1=b$；</li>
<li>$F_i=(F_{i-2}+F_{i-1})\bmod m  (i\ge 2)$</li>
</ul>
<p>求最小的 $p$ 使得 $F_p=0$。</p>
<p>有 $T$ 组询问（$T$ 不是小常数），每组询问给定 $a,b$，而 $m$ 是始终不变的。</p>
</blockquote>
<p>我去找找讲题 ppt，感觉和题解做法不一样。</p>
<hr>
<blockquote>
<p>例题 $39$：[JOISC 2021] Ancient Machine</p>
<p>通信题。</p>
<p>Alice 得到一个由 $n$ 个字符 $\text{X,Y,Z}$ 构成的序列，Bob 需要给定一个 $1,\ldots,n$ 的排列，按照排列顺序删除字符，要求使得“删除 $\text{Y}$ 时其前驱后继分别为 $\text{X,Z}$”的情况出现最多，Alice 只能给 Bob 发送 $70000$ 个 bit，$n=10^5$。</p>
</blockquote>
<p>考虑维护一个栈，记录第一个 $\text{X}$ 的位置，对于此后，遇到一个 $\text{X}$ 或 $\text{Y}$ 就进栈，遇到一个 $\text{Z}$ 就不断弹栈直到剩下最后一个 $\text{X}$，然后删掉这个 $\text{Z}$。</p>
<p>将 $\text{X,Y}$ 记作 $0$，将 $\text{Z}$ 记作 $1$，我们需要 $n+C$ 个 bit。</p>
<p>考虑序列中如果有些相邻的 $\text{Z}$，那么只留最后一个，其他全当成 $\text{X,Y}$ 进栈也没关系，所以我们可以把序列变成一个<strong>不包含连续 $1$ 的序列</strong>。</p>
<p>对于一个不包含连续 $1$ 的序列，我们有一种<strong>斐波那契编码</strong>可以将它的长度压缩。</p>
<p>斐波那契编码用一个 $0,1$ 串表示一个整数，右数第 $i$ 位的位权是 $Fib_i$，这个编码的特点是不含连续的 $1$（可以找到最靠前的两个连续 $1$ 进位）。</p>
<p><strong>因此这题里需要的序列可以被看做斐波那契编码，从而将其表示的值转化为一个二进制整数来传输，这样长度是 $\log_2 Fib_n+C$。</strong></p>
<p>实现时，可以对序列分段，将六十多个位分为一段用斐波那契编码转换二进制，可以通过本题。</p>
<p>时间复杂度为 $O(n)$。</p>
<hr>
<h3 id="斯特林数"><a href="#斯特林数" class="headerlink" title="斯特林数"></a>斯特林数</h3><p>定义<strong>第一类斯特林数</strong> $S_1(n,m)$ 表示将 $n$ 个带标号元素分入 $m$ 个无标号圆排列的方案数。</p>
<p>定义<strong>第二类斯特林数</strong> $S_2(n,m)$ 表示将 $n$ 个带标号元素分入 $m$ 个无标号非空集合的方案数。</p>
<p>定义<strong>上升幂</strong> $n^{\overline{m}}=\prod\limits_{i=n}^{n+m-1}i$，定义<strong>下降幂</strong> $n^{\underline{m}}=\prod\limits_{i=n-m+1}^n i$。</p>
<p>第一类斯特林数有递推式：</p>
<script type="math/tex; mode=display">
S_1(n,m)=S_1(n-1,m-1)+(n-1)\times S_1(n-1,m)</script><p>组合意义：加入第 $n$ 个元素时，要么新建一个圆，要么插入原有 $n-1$ 个元素其中一个的右手边。</p>
<p>第二类斯特林数有递推式：</p>
<script type="math/tex; mode=display">
S_2(n,m)=S_2(n-1,m-1)+m\times S_2(n-1,m)</script><p>组合意义：加入第 $n$ 个元素时，要么新建一个集合，要么插入一个原有的集合。</p>
<p>下降幂和上升幂可以互相转化，具体地：</p>
<script type="math/tex; mode=display">
n^{\overline{m}}=(-1)^m(-n)^{\underline{m}} \\
n^{\underline{m}}=(-1)^m(-n)^{\overline{m}}</script><hr>
<p>下面需要说明斯特林数和各种幂之间的关系：</p>
<p><strong>性质 $1$：第一类斯特林数和上升幂：</strong></p>
<script type="math/tex; mode=display">
x^{\overline{n}}=\sum\limits_{m=0}^n S_1(n,m)\times x^m</script><p>证明：第一类斯特林数 $S_1(n,m)$ 的递推式可以看成 $1,\ldots,n-1$ 的 $n-m$ 次<strong>初等对称轮换多项式</strong>的值，也就是从 $1,\ldots,n-1$ 中选出 $n-m$ 个数相乘的积相加的结果，这和 $x^{\overline{n}}$ 中 $x^m$ 项系数意义相同。</p>
<p>如果用式子说明，可以归纳，当 $n=0$ 时成立，否则：</p>
<script type="math/tex; mode=display">
x^{\overline{n}}=(x+n-1)x^{\overline{n-1}}=\sum\limits_{m=0}^{n-1}S_1(n-1,m)\times x^{m+1}+(n-1)\times S(n-1,m)\times x^m \\
=\sum\limits_{m=0}^n S_1(n,m)\times x^m</script><p><strong>性质 $2$：第二类斯特林数和下降幂：</strong></p>
<script type="math/tex; mode=display">
x^n=\sum\limits_{m=0}^n S_2(n,m)\times x^{\underline{m}}</script><p>证明：考虑组合意义，左边是把 $n$ 个带标号球放到 $x$ 个带标号盒子的方案数，右边枚举了非空盒子的个数 $m$，并依次从 $x$ 个盒子中选出 $m$ 个盒子（$x^{\underline{m}}=x(x-1)\ldots(x-m+1)$），并乘上无标号方案数 $S_2(n,m)$。</p>
<p>也可通过归纳证明，从略。</p>
<hr>
<p>下面要介绍一个关于斯特林数的反演：<strong>斯特林反演</strong>。</p>
<p>它的结论如下：</p>
<script type="math/tex; mode=display">
f(n)=\sum\limits_{m=0}^n S_1(n,m)\times g(m) \\
g(n)=\sum\limits_{m=0}^n(-1)^{n-m}\times S_2(n,m)\times f(m)</script><p>上两式等价。</p>
<p>当然，这个式子也能轻松推导出两个斯特林数交换后的结果同样成立。</p>
<p>上面已经叙述了两类斯特林数在常幂和上升下降幂之间转换的重要作用，也许已经可以感知到两类斯特林数对应两种互逆的运算，下面我们稍微推一下式子来感受一下：</p>
<script type="math/tex; mode=display">
x^n=\sum\limits_{m=0}^n S_2(n,m)\times x^{\underline{m}} \\
=\sum\limits_{m=0}^n S_2(n,m)\times (-1)^m\times (-x)^{\overline{m}} \\
=\sum\limits_{m=0}^n S_2(n,m)\times (-1)^m\times \sum\limits_{k=0}^m S_1(m,k)\times (-x)^k \\
=\sum\limits_{k=0}^n x^k\sum\limits_{m=k}^n (-1)^{m-k}\times S_2(n,m)\times S_1(m,k)</script><p>对比系数，就得到了一个重要的等式：</p>
<script type="math/tex; mode=display">
\sum\limits_{i=m}^n (-1)^{n-i}\times S_2(n,i)\times S_1(i,m)=[n=m]</script><p>如果先代第一类后带第二类，得到的应该是差不多的结果：</p>
<script type="math/tex; mode=display">
\sum\limits_{i=m}^n (-1)^{n-i}\times S_1(n,i)\times S_2(i,m)=[n=m]</script><p>将这个式子带入就可以证明<strong>斯特林反演公式</strong>：</p>
<script type="math/tex; mode=display">
g(n)=\sum\limits_{m=0}^n [n=m]g(m) \\
=\sum\limits_{m=0}^n\sum\limits_{i=m}^n (-1)^{n-i}\times S_2(n,i)\times S_1(i,m)\times g(m) \\
=\sum\limits_{i=0}^n (-1)^{n-i}\times S_2(n,i)\times \Big(\sum\limits_{m=0}^i S_1(i,m)\times g(m)\Big) \\
=\sum\limits_{i=0}^n(-1)^{n-i}\times S_2(n,i)\times f(i)</script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/02/25/%E7%A7%91%E6%99%AE%E6%96%87%E7%AB%A0/NOI%E4%B8%80%E8%BD%AE%E5%A4%8D%E4%B9%A0II/" rel="prev" title="科普文章 - NOI 一轮复习 II：字符串">
                  <i class="fa fa-chevron-left"></i> 科普文章 - NOI 一轮复习 II：字符串
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/02/25/%E7%A7%91%E6%99%AE%E6%96%87%E7%AB%A0/NOI%E4%B8%80%E8%BD%AE%E5%A4%8D%E4%B9%A0III/" rel="next" title="科普文章 - NOI 一轮复习 III：数据结构">
                  科普文章 - NOI 一轮复习 III：数据结构 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ix35</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.8/pdfobject.min.js","integrity":"sha256-tu9j5pBilBQrWSDePOOajCUdz6hWsid/lBNzK4KgEPM="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="/js/third-party/tags/pdf.js"></script>




  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.0/katex.min.css" integrity="sha256-uik/hNqHWZldXh/0K35nqOSCff9F61/ZOFReqNOBgB0=" crossorigin="anonymous">



</body>
</html>
